# 做计划 APP 后端项目结构

## 项目信息

| 项目 | 内容 |
|------|------|
| **项目名称** | plan-core |
| **技术栈** | Spring Boot 4.0 + MyBatis + MySQL + Druid |
| **JDK 版本** | 21 |
| **最后更新** | 2026-02-03 |

---

## 目录结构

```
plan-core/
├── docs/                                    # 文档目录
│   ├── architecture/                        # 架构设计文档
│   │   ├── API接口契约.md                   # API接口规范
│   │   ├── create.sql                       # 数据库建表脚本
│   │   ├── 领域模型设计.md                   # DDD领域模型设计
│   │   └── 双Token认证设计.md                # 双Token认证方案
│   ├── product/                             # 产品文档
│   │   ├── PRD_做计划APP_v2.0.md            # 主APP产品需求文档
│   │   └── PRD_做计划APP_运营后台_v1.0.md    # 运营后台产品需求文档
│   └── skills/                              # 技术规范
│       └── 技术约束&规范.md                  # 技术栈与设计规范
├── logs/                                    # 日志目录（运行时生成）
│   ├── plan-core-error.log                  # 错误日志
│   └── plan-core-info.log                   # 信息日志
├── src/
│   └── main/
│       ├── java/
│       │   └── com/gxl/plancore/
│       │       ├── PlanCoreApplication.java # Spring Boot 启动类
│       │       ├── common/                  # 共享内核
│       │       │   ├── config/              # 配置类
│       │       │   │   └── SecurityConfig.java     # 安全配置（密码加密器）
│       │       │   ├── exception/           # 异常体系
│       │       │   │   ├── BusinessException.java  # 业务异常
│       │       │   │   └── GlobalExceptionHandler.java # 全局异常处理
│       │       │   ├── response/            # 统一响应
│       │       │   │   ├── ApiResponse.java        # 统一响应结构
│       │       │   │   └── ErrorCode.java          # 错误码枚举
│       │       │   └── service/             # 公共服务
│       │       │       ├── EmailService.java       # 邮件发送服务
│       │       │       └── JwtService.java         # JWT Token服务
│       │       └── user/                    # 用户上下文
│       │           ├── interfaces/          # 接口层
│       │           │   ├── controller/
│       │           │   │   └── AuthController.java # 认证控制器
│       │           │   └── dto/
│       │           │       ├── LoginRequest.java         # 登录请求
│       │           │       ├── RegisterRequest.java      # 注册请求
│       │           │       ├── DeviceInfoRequest.java    # 设备信息请求
│       │           │       ├── AuthResponse.java         # 认证响应
│       │           │       ├── UserInfoResponse.java       # 用户信息响应
│       │           │       ├── EntitlementResponse.java    # 会员权益响应
│       │           │       ├── ForgotPasswordRequest.java  # 找回密码请求
│       │           │       ├── ForgotPasswordResponse.java # 找回密码响应
│       │           │       ├── DeviceResponse.java          # 设备信息响应
│       │           │       ├── DeviceListResponse.java      # 设备列表响应
│       │           │       ├── SessionStatusResponse.java   # 会话状态响应
│       │           │       ├── ChangePasswordRequest.java   # 修改密码请求
│       │           │       ├── ChangePasswordResponse.java  # 修改密码响应
│       │           │       ├── RefreshTokenRequest.java     # 刷新Token请求
│       │           │       └── RefreshTokenResponse.java    # 刷新Token响应
│       │           ├── application/         # 应用层
│       │           │   ├── command/
│       │           │   │   ├── LoginCommand.java           # 登录命令
│       │           │   │   ├── RegisterCommand.java        # 注册命令
│       │           │   │   ├── ForgotPasswordCommand.java  # 找回密码命令
│       │           │   │   └── ChangePasswordCommand.java  # 修改密码命令
│       │           │   ├── dto/
│       │           │   │   ├── UserDTO.java            # 用户DTO
│       │           │   │   ├── LoginResult.java        # 登录结果DTO
│       │           │   │   ├── RefreshResult.java      # 刷新Token结果DTO
│       │           │   │   ├── DeviceDTO.java          # 设备信息DTO
│       │           │   │   └── DeviceListDTO.java      # 设备列表DTO
│       │           │   └── service/
│       │           │       └── AuthApplicationService.java # 认证应用服务
│       │           ├── domain/              # 领域层
│       │           │   ├── entity/
│       │           │   │   ├── User.java               # 用户聚合根
│       │           │   │   └── DeviceSession.java      # 设备会话实体
│       │           │   ├── valueobject/
│       │           │   │   ├── UserId.java             # 用户ID值对象
│       │           │   │   ├── Email.java              # 邮箱值对象
│       │           │   │   ├── Password.java           # 密码值对象
│       │           │   │   └── Nickname.java           # 昵称值对象
│       │           │   └── repository/
│       │           │       ├── UserRepository.java     # 用户仓储接口
│       │           │       └── DeviceSessionRepository.java # 设备会话仓储接口
│       │           └── infrastructure/      # 基础设施层
│       │               └── persistence/
│       │                   ├── po/
│       │                   │   ├── UserPO.java         # 用户持久化对象
│       │                   │   └── DeviceSessionPO.java # 设备会话持久化对象
│       │                   ├── mapper/
│       │                   │   ├── UserMapper.java     # 用户Mapper
│       │                   │   └── DeviceSessionMapper.java # 设备会话Mapper
│       │                   ├── converter/
│       │                   │   ├── UserConverter.java  # 用户PO/领域对象转换
│       │                   │   └── DeviceSessionConverter.java # 设备会话转换
│       │                   └── repository/
│       │                       ├── UserRepositoryImpl.java # 用户仓储实现
│       │                       └── DeviceSessionRepositoryImpl.java # 设备会话仓储实现
│       └── resources/
│           ├── application.properties       # 应用配置文件
│           ├── logback.xml                  # 日志配置
│           └── mapper/                      # MyBatis Mapper XML（待添加）
├── pom.xml                                  # Maven 依赖配置
└── 项目结构.md                               # 本文件
```

---

## 变更记录

### 2026-02-03 - 实现刷新 Token 功能

**变更内容**：
- 实现使用 refresh_token 刷新 access_token 接口
- 验证 refresh_token 的 JWT 签名和有效性
- 验证数据库中会话状态和 Token 一致性
- 生成新的 access_token 和 refresh_token 并更新数据库

**已实现功能**：
1. `POST /api/v1/auth/refresh` - 刷新 Token 接口
   - 请求参数：refreshToken
   - 响应：accessToken、refreshToken、expiresIn（7200秒）
   - 错误码：401（refresh_token 无效或过期）

**涉及文件**：
- `user/interfaces/dto/RefreshTokenRequest.java` - 刷新Token请求 DTO（新增）
- `user/interfaces/dto/RefreshTokenResponse.java` - 刷新Token响应 DTO（新增）
- `user/application/dto/RefreshResult.java` - 刷新Token结果应用层 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 添加 refreshToken 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /refresh 接口

---

### 2026-02-03 - 实现修改密码功能

**变更内容**：
- 实现修改密码接口
- 验证旧密码正确性
- 验证新密码格式（8-20位）
- 修改成功后自动下线其他设备

**已实现功能**：
1. `POST /api/v1/auth/password` - 修改密码接口
   - 请求头：Authorization: Bearer {access_token}
   - 请求参数：oldPassword、newPassword
   - 响应：message（密码修改成功）
   - 错误码：1001（旧密码错误）、1005（新密码格式不正确）
   - 修改成功后，其他设备会话将被强制下线

**涉及文件**：
- `docs/architecture/API接口契约.md` - 添加 2.9 修改密码接口文档
- `user/interfaces/dto/ChangePasswordRequest.java` - 修改密码请求 DTO（新增）
- `user/interfaces/dto/ChangePasswordResponse.java` - 修改密码响应 DTO（新增）
- `user/application/command/ChangePasswordCommand.java` - 修改密码命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 changePassword 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /password 接口

---

### 2026-02-03 - 实现检查会话状态接口

**变更内容**：
- 新增检查会话状态接口，供前端定时轮询
- 如果会话失效（被踢出/退出/过期），返回 401 UNAUTHORIZED
- 更新 API 接口契约文档

**已实现功能**：
1. `GET /api/v1/auth/session/check` - 检查会话状态接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：valid（是否有效）、userId、deviceId
   - 会话无效时返回 401

**涉及文件**：
- `docs/architecture/API接口契约.md` - 添加 2.8 检查会话状态接口文档
- `user/interfaces/dto/SessionStatusResponse.java` - 会话状态响应 DTO（新增）
- `user/interfaces/controller/AuthController.java` - 添加 GET /session/check 接口

**前端使用建议**：
- 建议每 30-60 秒轮询一次
- 收到 401 响应时，清除本地 Token 并跳转到登录页

---

### 2026-02-03 - 增加会话有效性验证

**变更内容**：
- 增加数据库会话状态验证，确保被踢出/退出的设备无法继续访问
- 验证 device_session 表中的会话状态是否为 ACTIVE
- 验证 refresh_token 是否已过期

**影响接口**：
1. `GET /api/v1/auth/devices` - 查询设备列表
2. `POST /api/v1/auth/devices/{deviceId}/logout` - 踢出指定设备

**不验证的接口**：
- `POST /api/v1/auth/logout` - 退出登录（幂等，即使已退出也返回成功）

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 validateSession 方法
- `user/interfaces/controller/AuthController.java` - 在需要认证的接口中调用 validateSession

---

### 2026-02-03 - 实现退出登录功能

**变更内容**：
- 实现退出当前设备登录接口
- 吊销当前设备的 Token
- 支持幂等：重复退出返回成功

**已实现功能**：
1. `POST /api/v1/auth/logout` - 退出登录接口
   - 请求头：Authorization: Bearer {access_token}
   - 无请求参数
   - 幂等：重复退出返回成功

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 logout 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /logout 接口

---

### 2026-02-03 - 实现踢出指定设备功能

**变更内容**：
- 实现踢出非当前设备的接口
- 支持幂等：重复踢出返回成功
- 不允许踢出当前设备（返回错误码 2001）

**已实现功能**：
1. `POST /api/v1/auth/devices/{deviceId}/logout` - 踢出指定设备接口
   - 请求头：Authorization: Bearer {access_token}
   - 路径参数：deviceId（目标设备ID）
   - 错误码：2001（不能踢出当前设备）
   - 幂等：设备不存在或已退出时返回成功

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 logoutDevice 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /devices/{deviceId}/logout 接口

---

### 2026-02-03 - 实现查询设备列表功能

**变更内容**：
- 实现查询当前用户登录设备列表接口
- 区分当前设备和其他设备
- 从 access_token 中解析用户ID和设备ID

**已实现功能**：
1. `GET /api/v1/auth/devices` - 查询设备列表接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：currentDevice（当前设备）、otherDevices（其他设备列表）
   - 返回设备ID、设备名称、平台、最近登录IP、最近登录时间

**涉及文件**：
- `user/interfaces/dto/DeviceResponse.java` - 设备信息响应 DTO（新增）
- `user/interfaces/dto/DeviceListResponse.java` - 设备列表响应 DTO（新增）
- `user/application/dto/DeviceDTO.java` - 设备信息应用层 DTO（新增）
- `user/application/dto/DeviceListDTO.java` - 设备列表应用层 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 添加 getDevices 方法
- `user/interfaces/controller/AuthController.java` - 添加 getDevices 接口

---

### 2026-02-03 - 实现双Token认证与设备会话管理

**变更内容**：
- 实现 JWT 双 Token 认证（access_token + refresh_token）
- 实现设备会话管理（device_session 表）
- 支持多设备登录（最多10台设备同时在线）
- 超出设备数限制时自动踢出最早设备

**已实现功能**：
1. `POST /api/v1/auth/login` - 登录接口完善
   - 生成 access_token（2小时有效期）
   - 生成 refresh_token（30天有效期）
   - 写入设备会话记录到 device_session 表
   - 设备数量限制检查与自动踢出

**涉及文件**：
- `pom.xml` - 添加 JJWT 依赖（jjwt-api、jjwt-impl、jjwt-jackson）
- `application.properties` - 添加 JWT 配置和设备会话配置
- `common/service/JwtService.java` - JWT 工具类（新增）
- `user/domain/entity/DeviceSession.java` - 设备会话实体（新增）
- `user/domain/repository/DeviceSessionRepository.java` - 设备会话仓储接口（新增）
- `user/application/dto/LoginResult.java` - 登录结果 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 完善 login 方法
- `user/infrastructure/persistence/po/DeviceSessionPO.java` - 设备会话PO（新增）
- `user/infrastructure/persistence/mapper/DeviceSessionMapper.java` - 设备会话Mapper（新增）
- `user/infrastructure/persistence/converter/DeviceSessionConverter.java` - 转换器（新增）
- `user/infrastructure/persistence/repository/DeviceSessionRepositoryImpl.java` - 仓储实现（新增）
- `user/interfaces/controller/AuthController.java` - 更新登录响应

---

### 2026-02-03 - 实现找回密码功能

**变更内容**：
- 实现找回密码接口（生成新密码并发送邮件）
- 添加 Spring Boot Mail 依赖
- 配置 163 邮箱 SMTP 服务
- 实现频率限制（同一邮箱 1 分钟内只能发送 1 次）
- 支持随机密码生成

**已实现功能**：
1. `POST /api/v1/auth/forgot-password` - 找回密码接口
   - 请求参数：email
   - 响应：message（密码重置邮件已发送）
   - 错误码：1007（邮箱未注册）、429（请求过于频繁）

**涉及文件**：
- `pom.xml` - 添加 spring-boot-starter-mail 依赖
- `application.properties` - 添加邮件配置
- `common/service/EmailService.java` - 邮件发送服务（新增）
- `user/interfaces/dto/ForgotPasswordRequest.java` - 找回密码请求 DTO（新增）
- `user/interfaces/dto/ForgotPasswordResponse.java` - 找回密码响应 DTO（新增）
- `user/application/command/ForgotPasswordCommand.java` - 找回密码命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 forgotPassword 方法
- `user/interfaces/controller/AuthController.java` - 添加 forgot-password 接口
- `user/domain/entity/User.java` - 添加 changePassword 方法
- `user/domain/repository/UserRepository.java` - 添加 updatePassword 方法
- `user/infrastructure/persistence/mapper/UserMapper.java` - 添加 updatePassword SQL
- `user/infrastructure/persistence/repository/UserRepositoryImpl.java` - 实现 updatePassword

---

### 2026-02-03 - 实现用户登录功能

**变更内容**：
- 实现邮箱密码登录接口
- 添加登录请求/响应 DTO
- 添加会员权益响应 DTO
- 支持密码验证和用户查询

**已实现功能**：
1. `POST /api/v1/auth/login` - 用户登录接口
   - 请求参数：email、password、deviceInfo
   - 响应：userId、accessToken、refreshToken、userInfo、entitlement
   - 错误码：1001（邮箱或密码错误）

**涉及文件**：
- `user/interfaces/dto/LoginRequest.java` - 登录请求 DTO（新增）
- `user/interfaces/dto/EntitlementResponse.java` - 会员权益响应（新增）
- `user/application/command/LoginCommand.java` - 登录命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 login 方法
- `user/application/dto/UserDTO.java` - 添加 createdAt 字段
- `user/interfaces/controller/AuthController.java` - 添加登录接口
- `user/interfaces/dto/AuthResponse.java` - 添加 entitlement 字段

**待完成**：
- 会员权益状态查询（从数据库获取实际状态）

---

### 2026-02-02 - 实现用户注册功能

**变更内容**：
- 完成用户注册功能后端实现（Controller → Service → Repository）
- 采用 DDD 四层架构：Interfaces / Application / Domain / Infrastructure
- 实现共享内核：统一响应结构、错误码枚举、全局异常处理
- 实现用户领域模型：User 聚合根、值对象（UserId/Email/Password/Nickname）
- 实现持久化层：UserPO、UserMapper、UserRepositoryImpl
- 更新 create.sql：添加 email、password、nickname_modify_count 等字段

**已实现功能**：
1. `POST /api/v1/auth/register` - 用户注册接口
   - 请求参数：email、password、nickname、deviceInfo
   - 响应：userId、accessToken、refreshToken、userInfo
   - 错误码：1004（邮箱已注册）、1005（密码格式错误）、1006（昵称违规）

**涉及文件**：
- `docs/architecture/create.sql` - 添加 email/password 字段
- `pom.xml` - 添加 spring-security-crypto 依赖
- `common/response/ApiResponse.java` - 统一响应结构
- `common/response/ErrorCode.java` - 错误码枚举
- `common/exception/BusinessException.java` - 业务异常
- `common/exception/GlobalExceptionHandler.java` - 全局异常处理
- `common/config/SecurityConfig.java` - 密码加密器配置
- `user/interfaces/controller/AuthController.java` - 认证控制器
- `user/interfaces/dto/*.java` - 请求/响应 DTO
- `user/application/service/AuthApplicationService.java` - 认证应用服务
- `user/application/command/RegisterCommand.java` - 注册命令
- `user/application/dto/UserDTO.java` - 用户 DTO
- `user/domain/entity/User.java` - 用户聚合根
- `user/domain/valueobject/*.java` - 值对象
- `user/domain/repository/UserRepository.java` - 仓储接口
- `user/infrastructure/persistence/**` - 持久化实现

**待完成**：
- JWT Token 生成与验证
- 设备会话管理
- 会员权益初始化

---

### 2026-02-02 - 移除未打卡注销功能

**变更内容**：
- 移除"连续7天未打卡自动注销账号"功能
- 移除账号注销（Deactivated）状态
- 移除连续未打卡天数统计
- 移除未打卡提醒推送功能

**涉及文件**：
1. `docs/product/PRD_做计划APP_v2.0.md`
   - 删除 `2.9 7天未打卡注销+推送` 章节
   - 更新账号状态定义：移除 Deactivated 状态
   - 简化账号状态机和打卡状态机

2. `docs/architecture/领域模型设计.md`
   - 移除 `User.status`、`User.deactivatedAt`、`User.consecutiveUncheckDays` 属性
   - 移除 `deactivate()`、`incrementUncheckDays()` 等方法
   - 移除 `findUsersToDeactivate()` 仓储方法
   - 简化 `AccountStatus` 枚举（仅保留 ACTIVE）

3. `docs/architecture/API接口契约.md`
   - 移除错误码 `1002`（账号已注销）
   - 简化打卡接口说明

4. `docs/architecture/create.sql`
   - 移除 `user.status`、`user.deactivated_at` 字段
   - 移除注销相关系统配置项
   - 移除注销相关定时任务说明

5. `docs/product/PRD_做计划APP_运营后台_v1.0.md`
   - 移除账号状态筛选（正常/已注销）
   - 移除注销原因、注销时间字段
   - 移除"标记退款"、"批量退款"功能
   - 移除注销用户数、注销率统计
   - 移除未打卡推送配置

---

### 2026-02-02 - 登录/注册统一规范

**变更内容**：
- 移除所有微信授权登录相关功能
- 登录方式改为：**邮箱 + 密码**
- 注册方式改为：**邮箱 + 密码 + 昵称**
- 找回密码改为：**仅输入邮箱**

**涉及文件**：
1. `docs/architecture/领域模型设计.md`
   - 移除 `WechatOpenId` 值对象
   - 新增 `Email` 值对象（用户邮箱，登录唯一标识）
   - 新增 `Password` 值对象（用户密码，加密存储）
   - 更新 `UserRepository` 接口：`findByOpenId` → `findByEmail`

2. `docs/architecture/API接口契约.md`
   - 移除 `2.1 微信授权登录` 接口
   - 新增 `2.1 邮箱密码登录` 接口
   - 新增 `2.2 用户注册` 接口
   - 新增 `2.3 找回密码` 接口
   - 更新错误码：新增 1004-1007

3. `docs/product/PRD_做计划APP_v2.0.md`
   - 免费期起算时间改为"首次注册"
   - 登录状态机改为"邮箱密码登录"

---

### 2026-02-02 - Spring Boot 工程初始化

**变更内容**：
- 项目转换为 Spring Boot 4.0 工程
- 配置 Maven 依赖：MyBatis、Druid、Fastjson2、MySQL 驱动
- 添加 `application.properties` 配置文件
- 添加 `logback.xml` 日志配置

**涉及文件**：
1. `pom.xml` - Maven 依赖配置
2. `src/main/java/com/gxl/plancore/PlanCoreApplication.java` - 启动类
3. `src/main/resources/application.properties` - 应用配置
4. `src/main/resources/logback.xml` - 日志配置

---

## 技术栈

| 组件 | 版本 | 说明 |
|------|------|------|
| JDK | 21 | Java 运行时 |
| Spring Boot | 4.0.0 | Web 框架 |
| MyBatis | 4.0.1 | ORM 框架 |
| Druid | 1.2.27 | 数据库连接池 |
| MySQL | 9.2.0 | 数据库 |
| Fastjson2 | 2.0.43 | JSON 处理 |
| JJWT | 0.12.6 | JWT 生成与验证 |
| Logback | (Spring Boot 内置) | 日志框架 |

---

## 数据库配置

| 配置项 | 值 |
|--------|-----|
| Host | 127.0.0.1:3306 |
| Database | PlanCore |
| Username | root |
| Password | 123456 |

---

## 启动方式

```bash
# 编译
mvn clean compile

# 运行
mvn spring-boot:run

# 打包
mvn clean package
```
