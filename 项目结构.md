# 做计划 APP 后端项目结构

## 项目信息

| 项目 | 内容 |
|------|------|
| **项目名称** | plan-core |
| **技术栈** | Spring Boot 4.0 + MyBatis + MySQL + Druid |
| **JDK 版本** | 21 |
| **最后更新** | 2026-02-24 |

---

## 目录结构

```
plan-core/
├── docs/                                    # 文档目录
│   ├── architecture/                        # 架构设计文档
│   │   ├── API接口契约.md                   # API接口规范
│   │   ├── create.sql                       # 数据库建表脚本
│   │   ├── 领域模型设计.md                   # DDD领域模型设计
│   │   ├── 双Token认证设计.md                # 双Token认证方案
│   │   └── 授权功能架构设计.md                # 授权功能架构设计（双Token JWT）
│   ├── product/                             # 产品文档
│   │   ├── PRD_做计划APP_v2.0.md            # 主APP产品需求文档
│   │   └── PRD_做计划APP_运营后台_v1.0.md    # 运营后台产品需求文档
│   └── skills/                              # 技术规范
│       └── 技术约束&规范.md                  # 技术栈与设计规范
├── logs/                                    # 日志目录（运行时生成）
│   ├── plan-core-error.log                  # 错误日志
│   └── plan-core-info.log                   # 信息日志
├── src/
│   └── main/
│       ├── java/
│       │   └── com/gxl/plancore/
│       │       ├── PlanCoreApplication.java # Spring Boot 启动类
│       │       ├── common/                  # 共享内核
│       │       │   ├── config/              # 配置类
│       │       │   │   └── SecurityConfig.java     # 安全配置（密码加密器）
│       │       │   ├── exception/           # 异常体系
│       │       │   │   ├── BusinessException.java  # 业务异常
│       │       │   │   └── GlobalExceptionHandler.java # 全局异常处理
│       │       │   ├── response/            # 统一响应
│       │       │   │   ├── ApiResponse.java        # 统一响应结构
│       │       │   │   └── ErrorCode.java          # 错误码枚举
│       │       │   └── service/             # 公共服务
│       │       │       ├── EmailService.java       # 邮件发送服务
│       │       │       └── JwtService.java         # JWT Token服务
│       │       ├── focus/                    # 专注上下文
│       │       │   ├── interfaces/          # 接口层
│       │       │   │   ├── controller/
│       │       │   │   │   └── FocusController.java     # 专注控制器
│       │       │   │   └── dto/
│       │       │   │       ├── StartFocusRequest.java    # 开始专注请求
│       │       │   │       ├── StartFocusResponse.java   # 开始专注响应
│       │       │   │       ├── EndFocusRequest.java      # 结束专注请求
│       │       │   │       ├── EndFocusResponse.java     # 结束专注响应
│       │       │   │       └── TotalFocusTimeResponse.java # 总专注时间响应
│       │       │   ├── application/         # 应用层
│       │       │   │   ├── command/
│       │       │   │   │   ├── StartFocusCommand.java   # 开始专注命令
│       │       │   │   │   └── EndFocusCommand.java     # 结束专注命令
│       │       │   │   ├── dto/
│       │       │   │   │   ├── StartFocusResult.java    # 开始专注结果DTO
│       │       │   │   │   └── EndFocusResult.java      # 结束专注结果DTO
│       │       │   │   └── service/
│       │       │   │       └── FocusApplicationService.java # 专注应用服务
│       │       │   ├── domain/              # 领域层
│       │       │   │   ├── entity/
│       │       │   │   │   ├── FocusSession.java        # 专注会话聚合根
│       │       │   │   │   └── FocusStats.java          # 专注统计实体
│       │       │   │   ├── valueobject/
│       │       │   │   │   ├── SessionId.java           # 会话ID值对象
│       │       │   │   │   ├── FocusDuration.java       # 专注时长值对象
│       │       │   │   │   ├── FocusType.java           # 专注类型枚举
│       │       │   │   │   ├── SessionStatus.java       # 会话状态枚举
│       │       │   │   │   └── EndType.java             # 结束类型枚举
│       │       │   │   └── repository/
│       │       │   │       ├── FocusSessionRepository.java # 专注会话仓储接口
│       │       │   │       └── FocusStatsRepository.java   # 专注统计仓储接口
│       │       │   └── infrastructure/      # 基础设施层
│       │       │       └── persistence/
│       │       │           ├── po/
│       │       │           │   ├── FocusSessionPO.java  # 专注会话持久化对象
│       │       │           │   └── FocusStatsPO.java    # 专注统计持久化对象
│       │       │           ├── mapper/
│       │       │           │   ├── FocusSessionMapper.java # 专注会话Mapper
│       │       │           │   └── FocusStatsMapper.java   # 专注统计Mapper
│       │       │           ├── converter/
│       │       │           │   ├── FocusSessionConverter.java # 专注会话转换
│       │       │           │   └── FocusStatsConverter.java   # 专注统计转换
│       │       │           └── repository/
│       │       │               ├── FocusSessionRepositoryImpl.java # 专注会话仓储实现
│       │       │               └── FocusStatsRepositoryImpl.java   # 专注统计仓储实现
│       │       ├── task/                     # 任务上下文
│       │       │   ├── interfaces/           # 接口层
│       │       │   │   ├── controller/
│       │       │   │   │   └── TaskController.java        # 任务控制器
│       │       │   │   └── dto/
│       │       │   │       ├── ChartDataResponse.java     # 图表数据项响应
   │       │       │   │       ├── CreateTaskRequest.java     # 创建任务请求
   │       │       │   │       ├── CreateTaskResponse.java    # 创建任务响应
   │       │       │   │       ├── UpdateTaskRequest.java     # 更新任务请求
   │       │       │   │       ├── UpdateTaskResponse.java    # 更新任务响应
   │       │       │   │       ├── DeleteTaskResponse.java    # 删除任务响应
   │       │       │   │       ├── PerDateTaskListResponse.java # 单日任务列表响应
   │       │       │   │       ├── ToggleCompleteRequest.java # 完成/反完成请求
   │       │       │   │       ├── ToggleCompleteResponse.java# 完成/反完成响应
   │       │       │   │       ├── TaskListResponse.java      # 任务列表响应
   │       │       │   │       ├── TaskResponse.java          # 单个任务响应
   │       │       │   │       └── TaskStatsResponse.java     # 任务统计视图响应
│       │       │   ├── application/          # 应用层
│       │       │   │   ├── command/
│       │       │   │   │   ├── CreateTaskCommand.java     # 创建任务命令
   │       │       │   │   │   └── UpdateTaskCommand.java     # 更新任务命令
   │       │       │   │   ├── dto/
   │       │       │   │   │   ├── ChartDataItem.java         # 图表数据项DTO
   │       │       │   │   │   ├── CreateTaskResult.java      # 创建任务结果DTO
   │       │       │   │   │   ├── PerDateTaskData.java       # 单日任务数据DTO
   │       │       │   │   │   ├── UpdateTaskResult.java      # 更新任务结果DTO
   │       │       │   │   │   ├── DeleteTaskResult.java      # 删除任务结果DTO
   │       │       │   │   │   ├── ToggleCompleteResult.java  # 完成/反完成结果DTO
   │       │       │   │   │   ├── TaskDTO.java               # 任务DTO
   │       │       │   │   │   ├── TaskListResult.java        # 任务列表结果DTO
   │       │       │   │   │   └── TaskStatsResult.java       # 任务统计结果DTO
│       │       │   │   └── service/
│       │       │   │       └── TaskApplicationService.java # 任务应用服务
│       │       │   ├── domain/               # 领域层
   │       │       │   │   ├── entity/
   │       │       │   │   │   └── Task.java                 # 任务聚合根
   │       │       │   │   ├── valueobject/
   │       │       │   │   │   ├── TaskDateCount.java        # 任务日期计数值对象
   │       │       │   │   │   ├── TaskPriority.java         # 任务优先级
   │       │       │   │   │   └── TaskStatus.java           # 任务状态
│       │       │   │   └── repository/
│       │       │   │       └── TaskRepository.java       # 任务仓储接口
│       │       │   └── infrastructure/       # 基础设施层
   │       │       │       └── persistence/
   │       │       │           ├── po/
   │       │       │           │   ├── TaskCountPO.java       # 任务计数持久化对象
   │       │       │           │   └── TaskPO.java            # 任务持久化对象
│       │       │           ├── mapper/
│       │       │           │   └── TaskMapper.java        # 任务Mapper
│       │       │           ├── converter/
│       │       │           │   └── TaskConverter.java     # 任务PO/领域对象转换
│       │       │           └── repository/
   │       │       │               └── TaskRepositoryImpl.java # 任务仓储实现
   │       │       ├── checkin/                  # 打卡上下文
   │       │       │   ├── interfaces/           # 接口层
   │       │       │   │   ├── controller/
   │       │       │   │   │   └── CheckInController.java     # 打卡控制器
   │       │       │   │   └── dto/
   │       │       │   │       ├── CheckInRequest.java         # 打卡请求
   │       │       │   │       ├── CheckInResponse.java        # 打卡响应
   │       │       │   │       └── CheckInStreakResponse.java   # 连续天数响应
   │       │       │   ├── application/          # 应用层
   │       │       │   │   ├── dto/
   │       │       │   │   │   ├── CheckInResult.java          # 打卡结果DTO
   │       │       │   │   │   └── CheckInStreakResult.java     # 连续天数结果DTO
   │       │       │   │   └── service/
   │       │       │   │       └── CheckInApplicationService.java # 打卡应用服务
   │       │       │   ├── domain/               # 领域层
   │       │       │   │   ├── entity/
   │       │       │   │   │   └── CheckIn.java                # 打卡聚合根
   │       │       │   │   └── repository/
   │       │       │   │       └── CheckInRepository.java      # 打卡仓储接口
   │       │       │   └── infrastructure/       # 基础设施层
   │       │       │       └── persistence/
   │       │       │           ├── po/
   │       │       │           │   └── CheckInPO.java           # 打卡持久化对象
   │       │       │           ├── mapper/
   │       │       │           │   └── CheckInMapper.java       # 打卡Mapper
   │       │       │           ├── converter/
   │       │       │           │   └── CheckInConverter.java    # 打卡PO/领域对象转换
   │       │       │           └── repository/
   │       │       │               └── CheckInRepositoryImpl.java # 打卡仓储实现
   │       │       └── user/                    # 用户上下文
│       │           ├── interfaces/          # 接口层
│       │           │   ├── controller/
│       │           │   │   ├── AuthController.java # 认证控制器
│       │           │   │   └── UserController.java # 用户中心控制器
│       │           │   └── dto/
│       │           │       ├── LoginRequest.java         # 登录请求
│       │           │       ├── RegisterRequest.java      # 注册请求
│       │           │       ├── DeviceInfoRequest.java    # 设备信息请求
│       │           │       ├── AuthResponse.java         # 认证响应
│       │           │       ├── UserInfoResponse.java       # 用户信息响应
│       │           │       ├── EntitlementResponse.java    # 会员权益响应
│       │           │       ├── ForgotPasswordRequest.java  # 找回密码请求
│       │           │       ├── ForgotPasswordResponse.java # 找回密码响应
│       │           │       ├── DeviceResponse.java          # 设备信息响应
│       │           │       ├── DeviceListResponse.java      # 设备列表响应
│       │           │       ├── SessionStatusResponse.java   # 会话状态响应
│       │           │       ├── ChangePasswordRequest.java   # 修改密码请求
│       │           │       ├── ChangePasswordResponse.java  # 修改密码响应
│       │           │       ├── RefreshTokenRequest.java     # 刷新Token请求
│       │           │       ├── RefreshTokenResponse.java    # 刷新Token响应
│       │           │       ├── UpdateProfileRequest.java    # 更新用户资料请求
│       │           │       ├── UpdateProfileResponse.java   # 更新用户资料响应
│       │           │       └── UserProfileResponse.java     # 查询用户信息响应
│       │           ├── application/         # 应用层
│       │           │   ├── command/
│       │           │   │   ├── LoginCommand.java           # 登录命令
│       │           │   │   ├── RegisterCommand.java        # 注册命令
│       │           │   │   ├── ForgotPasswordCommand.java  # 找回密码命令
│       │           │   │   ├── ChangePasswordCommand.java  # 修改密码命令
│       │           │   │   └── UpdateProfileCommand.java   # 更新用户资料命令
│       │           │   ├── dto/
│       │           │   │   ├── UserDTO.java            # 用户DTO
│       │           │   │   ├── LoginResult.java        # 登录结果DTO
│       │           │   │   ├── RefreshResult.java      # 刷新Token结果DTO
│       │           │   │   ├── DeviceDTO.java          # 设备信息DTO
│       │           │   │   └── DeviceListDTO.java      # 设备列表DTO
│       │           │   └── service/
│       │           │       ├── AuthApplicationService.java  # 认证应用服务
│       │           │       └── UserApplicationService.java  # 用户应用服务
│       │           ├── domain/              # 领域层
│       │           │   ├── entity/
│       │           │   │   ├── User.java               # 用户聚合根
│       │           │   │   └── DeviceSession.java      # 设备会话实体
│       │           │   ├── valueobject/
│       │           │   │   ├── UserId.java             # 用户ID值对象
│       │           │   │   ├── Email.java              # 邮箱值对象
│       │           │   │   ├── Password.java           # 密码值对象
│       │           │   │   └── Nickname.java           # 昵称值对象
│       │           │   └── repository/
│       │           │       ├── UserRepository.java     # 用户仓储接口
│       │           │       └── DeviceSessionRepository.java # 设备会话仓储接口
│       │           └── infrastructure/      # 基础设施层
│       │               └── persistence/
│       │                   ├── po/
│       │                   │   ├── UserPO.java         # 用户持久化对象
│       │                   │   └── DeviceSessionPO.java # 设备会话持久化对象
│       │                   ├── mapper/
│       │                   │   ├── UserMapper.java     # 用户Mapper
│       │                   │   └── DeviceSessionMapper.java # 设备会话Mapper
│       │                   ├── converter/
│       │                   │   ├── UserConverter.java  # 用户PO/领域对象转换
│       │                   │   └── DeviceSessionConverter.java # 设备会话转换
│       │                   └── repository/
│       │                       ├── UserRepositoryImpl.java # 用户仓储实现
│       │                       └── DeviceSessionRepositoryImpl.java # 设备会话仓储实现
│       └── resources/
│           ├── application.properties       # 应用配置文件
│           ├── logback.xml                  # 日志配置
│           └── mapper/                      # MyBatis Mapper XML（待添加）
├── pom.xml                                  # Maven 依赖配置
├── scripts/                                 # 运维脚本
│   └── plan-core.sh                         # CentOS 7 启动脚本
└── 项目结构.md                               # 本文件
```

---

## 变更记录

### 2026-02-24 - 新增 CentOS 7 启动脚本

**变更内容**：
- 新增 `scripts/plan-core.sh` 启动脚本
- 支持 start/stop/restart/status 命令
- JVM: -Xms2G -Xmx2G，G1 GC
- PID 文件、日志输出、OOM 时 HeapDump
- JAR 与脚本同目录部署（如 /opt/plancore），logs 子目录存放日志

---

### 2026-02-24 - 配置应用上下文路径

**变更内容**：
- 新增 `server.servlet.context-path=/plancore` 配置
- 所有 API 访问路径需在端口后增加 `/plancore` 前缀
- 示例：`http://127.0.0.1:8080/plancore/api/v1/focus/start`

**修改文件**：
- `src/main/resources/application.properties` - 新增 context-path 配置

---

### 2026-02-12 - 查询任务列表支持多日期

**变更内容**：
- 查询任务列表接口 `GET /api/v1/tasks` 支持多日期查询
- 新增参数 `dates`：逗号分隔的多个日期，如 `dates=2026-02-10,2026-02-11,2026-02-12`
- 保留参数 `date`：单日期查询（向后兼容），与 `dates` 二选一
- 多日期时返回 `dataByDate`，key 为日期，value 为当日 `hasUncheckedTasks` 与 `tasks`
- 单日期时保持原响应格式 `date`、`hasUncheckedTasks`、`tasks`
- 多日期查询使用 `findByUserIdAndDateRange` 一次查询，再按日期分组，避免 N 次查询

**新增文件**：
- `task/application/dto/PerDateTaskData.java` - 单日任务数据 DTO
- `task/interfaces/dto/PerDateTaskListResponse.java` - 单日任务列表响应 DTO

**修改文件**：
- `task/application/dto/TaskListResult.java` - 新增 dataByDate、isMultiDate 支持多日期
- `task/application/service/TaskApplicationService.java` - 新增 queryTasksByDates 方法
- `task/interfaces/dto/TaskListResponse.java` - 新增 dataByDate 字段
- `task/interfaces/controller/TaskController.java` - 支持 date/dates 参数，convertToResponse 处理多日期
- `docs/architecture/API接口契约.md` - 更新 3.1 查询任务列表接口文档

---

### 2026-02-12 - 实现打卡功能及查询连续天数

**变更内容**：
- 新建 `checkin` 打卡限界上下文，完整 DDD 四层架构
- 实现打卡接口 `POST /api/v1/check-in`
  - 幂等：当日重复打卡返回已有记录，不产生副作用
  - 连续天数计算：查找前一天打卡记录，有则 +1，无则重置为 1
  - 打卡时同步更新 user 表的 `consecutive_days` 和 `last_check_in_date`（防腐层适配）
- 实现查询连续天数接口 `GET /api/v1/check-in/streak`
  - 最近打卡日是今天或昨天 → 连续天数有效
  - 最近打卡日早于昨天 → 已断签，返回 0
  - 无打卡记录 → 返回 0

**新增文件**：
- `checkin/domain/entity/CheckIn.java` - 打卡聚合根
- `checkin/domain/repository/CheckInRepository.java` - 打卡仓储接口
- `checkin/infrastructure/persistence/po/CheckInPO.java` - 打卡持久化对象
- `checkin/infrastructure/persistence/mapper/CheckInMapper.java` - 打卡 Mapper（含 user 表防腐层更新）
- `checkin/infrastructure/persistence/converter/CheckInConverter.java` - 打卡转换器
- `checkin/infrastructure/persistence/repository/CheckInRepositoryImpl.java` - 打卡仓储实现
- `checkin/application/dto/CheckInResult.java` - 打卡结果 DTO
- `checkin/application/dto/CheckInStreakResult.java` - 连续天数结果 DTO
- `checkin/application/service/CheckInApplicationService.java` - 打卡应用服务
- `checkin/interfaces/dto/CheckInRequest.java` - 打卡请求 DTO
- `checkin/interfaces/dto/CheckInResponse.java` - 打卡响应 DTO
- `checkin/interfaces/dto/CheckInStreakResponse.java` - 连续天数响应 DTO
- `checkin/interfaces/controller/CheckInController.java` - 打卡控制器

**修改文件**：
- `docs/architecture/API接口契约.md` - 新增 3.8 查询打卡连续天数接口文档，补充 3.7 打卡连续天数计算规则

---

### 2026-02-12 - 实现任务数据统计视图查询功能

**变更内容**：
- 实现任务数据统计视图接口 `GET /api/v1/tasks/stats`
- 支持"周"（WEEK）和"月"（MONTH）两种查询维度
- 周维度：以 ISO 标准周（周一~周日）为周期，返回每天的完成率和未完成率
- 月维度：以自然月为周期，按周分组（第1周1-7日、第2周8-14日、...），返回每周的完成率和未完成率
- 每次查询同时返回统计图表数据 + 已完成/未完成任务列表
- 支持按优先级筛选（可选 P0/P1/P2/P3，逗号分隔），默认查询全部优先级
- 完成率保留2位小数，无任务时返回 0.0
- 更新 API 接口契约文档中的 4.1 任务数据统计视图

**性能优化（拆分两次查询）**：
- 查询1：统计数据使用 `COUNT + GROUP BY` 聚合查询，仅返回 (date, priority, status, count) 计数行，不加载任务实体对象
- 查询2：任务明细仅查询 `date` 参数指定当天的任务列表，不加载整个周/月的全量数据
- 新增 `TaskCountPO` 持久化对象（COUNT + GROUP BY 结果映射）
- 新增 `TaskDateCount` 领域值对象（轻量计数结构，避免 PO 穿透领域层）

**新增文件**：
- `task/domain/valueobject/TaskDateCount.java` - 任务日期计数值对象
- `task/infrastructure/persistence/po/TaskCountPO.java` - 任务计数持久化对象
- `task/application/dto/ChartDataItem.java` - 图表数据项 DTO
- `task/application/dto/TaskStatsResult.java` - 任务统计结果 DTO
- `task/interfaces/dto/ChartDataResponse.java` - 图表数据项响应 DTO
- `task/interfaces/dto/TaskStatsResponse.java` - 任务统计视图响应 DTO

**修改文件**：
- `task/domain/repository/TaskRepository.java` - 新增 `findByUserIdAndDateRange`、`countGroupedByDateRange` 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 `findByUserIdAndDateRange`、`countGroupedByDateRange` SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现新增仓储方法
- `task/application/service/TaskApplicationService.java` - 新增 `queryTaskStats` 方法（两次查询架构）
- `task/interfaces/controller/TaskController.java` - 新增 `GET /stats` 端点
- `docs/architecture/API接口契约.md` - 更新 4.1 任务数据统计视图接口文档

---

### 2026-02-12 - 实现完成/反完成任务功能

**变更内容**：
- 实现完成/反完成任务接口 `POST /api/v1/tasks/{taskId}/toggle-complete`
- 请求参数 `completed: true` 完成任务，`completed: false` 反完成任务
- 完成时设置 `status=COMPLETED` 和 `completedAt`，反完成时恢复 `status=INCOMPLETE` 并清除 `completedAt`
- 校验任务归属（仅允许操作自己的任务）
- 任务不存在时返回错误码 3009

**新增文件**：
- `task/application/dto/ToggleCompleteResult.java` - 完成/反完成结果 DTO
- `task/interfaces/dto/ToggleCompleteRequest.java` - 完成/反完成请求 DTO
- `task/interfaces/dto/ToggleCompleteResponse.java` - 完成/反完成响应 DTO

**修改文件**：
- `task/domain/entity/Task.java` - 新增 `complete()`、`uncomplete()` 领域方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 扩展 `update` SQL 包含 status 和 completed_at
- `task/application/service/TaskApplicationService.java` - 新增 `toggleComplete()` 方法
- `task/interfaces/controller/TaskController.java` - 新增 `POST /{taskId}/toggle-complete` 端点

---

### 2026-02-12 - 实现更新任务和删除任务功能

**变更内容**：
- 实现更新任务接口 `PUT /api/v1/tasks/{taskId}`
  - 支持可选更新 title、priority、date 字段
  - 校验任务归属（仅允许更新自己的任务）
  - 校验标题长度、优先级格式、日期范围
- 实现删除任务接口 `DELETE /api/v1/tasks/{taskId}`
  - 逻辑删除（soft delete）
  - 幂等支持（任务不存在或已删除返回成功，deletedCount=0）
  - 校验任务归属

**新增文件**：
- `task/application/command/UpdateTaskCommand.java` - 更新任务命令
- `task/application/dto/UpdateTaskResult.java` - 更新任务结果 DTO
- `task/application/dto/DeleteTaskResult.java` - 删除任务结果 DTO
- `task/interfaces/dto/UpdateTaskRequest.java` - 更新任务请求 DTO
- `task/interfaces/dto/UpdateTaskResponse.java` - 更新任务响应 DTO
- `task/interfaces/dto/DeleteTaskResponse.java` - 删除任务响应 DTO

**修改文件**：
- `task/domain/entity/Task.java` - 新增 `updateInfo()`、`softDelete()`、`isDeleted()` 领域方法
- `task/domain/repository/TaskRepository.java` - 新增 `findByTaskId()`、`update()`、`softDelete()` 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 `findByTaskId`、`update`、`softDelete` SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现新增仓储方法
- `task/application/service/TaskApplicationService.java` - 新增 `updateTask()`、`deleteTask()` 方法
- `task/interfaces/controller/TaskController.java` - 新增 `PUT /{taskId}` 和 `DELETE /{taskId}` 端点

---

### 2026-02-12 - 实现查询任务列表功能

**变更内容**：
- 实现查询任务列表接口 `GET /api/v1/tasks?date=YYYY-MM-DD&showCompleted=true`
- 按优先级分组（P0/P1/P2/P3）返回任务列表，同象限内按创建时间升序排列
- 返回各象限是否有未完成任务标记（hasUncheckedTasks），用于日历小圆点展示
- 支持 showCompleted 参数过滤已完成任务（默认 true 显示全部）

**新增文件**：
- `task/application/dto/TaskDTO.java` - 任务 DTO
- `task/application/dto/TaskListResult.java` - 任务列表结果 DTO
- `task/interfaces/dto/TaskResponse.java` - 单个任务响应 DTO
- `task/interfaces/dto/TaskListResponse.java` - 任务列表响应 DTO

**修改文件**：
- `task/domain/repository/TaskRepository.java` - 新增 `findByUserIdAndDate` 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 `findByUserIdAndDate` SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现 `findByUserIdAndDate`
- `task/application/service/TaskApplicationService.java` - 新增 `queryTasksByDate` 方法
- `task/interfaces/controller/TaskController.java` - 新增 `GET /api/v1/tasks` 端点

---

### 2026-02-12 - 实现创建任务功能

**变更内容**：
- 实现创建任务接口 `POST /api/v1/tasks`
- 采用 DDD 四层架构：Interfaces / Application / Domain / Infrastructure
- 支持标题校验（1-100字符）、优先级校验（P0/P1/P2/P3）、日期范围校验（今天-365天 ~ 今天+365天）
- 支持单日任务数上限检查（50 条）
- 任务名称允许重复，不做幂等限制
- 通过 AuthInterceptor 拦截器获取用户ID，无需在 Controller 中解析 Token

**新增文件**：
- `task/domain/valueobject/TaskPriority.java` - 任务优先级枚举
- `task/domain/valueobject/TaskStatus.java` - 任务状态枚举
- `task/domain/entity/Task.java` - 任务聚合根
- `task/domain/repository/TaskRepository.java` - 任务仓储接口
- `task/infrastructure/persistence/po/TaskPO.java` - 任务持久化对象
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 任务 Mapper
- `task/infrastructure/persistence/converter/TaskConverter.java` - 任务转换器
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 任务仓储实现
- `task/application/command/CreateTaskCommand.java` - 创建任务命令
- `task/application/dto/CreateTaskResult.java` - 创建任务结果 DTO
- `task/application/service/TaskApplicationService.java` - 任务应用服务
- `task/interfaces/dto/CreateTaskRequest.java` - 创建任务请求 DTO
- `task/interfaces/dto/CreateTaskResponse.java` - 创建任务响应 DTO
- `task/interfaces/controller/TaskController.java` - 任务控制器

---

### 2026-02-10 - 基于精简需求重写授权功能架构文档

**变更内容**：
- 按最新需求重写授权功能架构设计，聚焦双 Token（accessToken + refreshToken）机制
- 明确登录复用 refreshToken、AOP 验签、refreshToken 验证与失效接口的设计
- 基于 `create.sql` 的 `device_session` 表给出会话与 Token 管理方案
- 补充前后端交互时序、安全策略、配置建议与验收标准

**新增文件**：
- `docs/architecture/授权功能架构设计.md` - 授权功能架构设计文档（双Token JWT）

---

### 2026-02-10 - 新增双 Token 认证设计文档

**变更内容**：
- 新增双 Token 认证设计文档，详细描述 AOP 验签方案
- 设计 JwtAuthInterceptor 拦截器（白名单模式）
- 设计 AuthContext 认证上下文持有器
- 设计验证/吊销 refreshToken 接口
- 规划 accessToken 有效期从 2 小时调整为 30 分钟（可配置）

**新增文件**：
- `docs/architecture/双Token认证设计.md` - 双 Token 认证设计方案

---

### 2026-02-09 - 修复模板分裂后新模板继承了截断后的 repeatEndDate 导致查不到虚拟任务

**变更内容**：
- 修复 THIS_AND_FUTURE 模板分裂时，先截断旧模板 `repeatEndDate`，再用已截断的旧模板创建新模板，导致新模板 `repeatEndDate` 早于自身 `date`，永远不会被查询命中
- 在截断旧模板之前保存原始 `repeatEndDate`，传给 `createSplitTemplate` 使用

**修改文件**：
- `task/domain/entity/Task.java` - `createSplitTemplate` 新增 `repeatEndDate` 参数，不再从已截断的旧模板读取
- `task/application/service/TaskApplicationService.java` - `updateRepeatThisAndFuture` 中先保存原始结束日期再截断

---

### 2026-02-09 - 实现完成/反完成任务功能

**变更内容**：
- 实现完成/反完成任务接口 `POST /api/v1/tasks/{taskId}/toggle-complete`
- 支持普通任务和实例任务直接切换完成状态
- 支持虚拟任务自动实例化后切换状态，实例化后成为独立实体，不受模板影响
- 每天的重复任务有独立的完成状态，互不影响

**新增文件**：
- `task/application/command/ToggleCompleteCommand.java` - 完成/反完成命令
- `task/application/dto/ToggleCompleteResult.java` - 完成/反完成结果 DTO
- `task/interfaces/dto/ToggleCompleteRequest.java` - 完成/反完成请求 DTO
- `task/interfaces/dto/ToggleCompleteResponse.java` - 完成/反完成响应 DTO

**修改文件**：
- `task/domain/entity/Task.java` - 新增 `complete()` 和 `uncomplete()` 方法
- `task/application/service/TaskApplicationService.java` - 新增 `toggleComplete` 方法
- `task/interfaces/controller/TaskController.java` - 新增 `POST /{taskId}/toggle-complete` 端点

---

### 2026-02-09 - 修复 THIS_ONLY 删除需要两次才生效

**变更内容**：
- 修复 `insert` SQL 缺少 `deleted_at` 字段，导致"出生即死亡"实例的 `deleted_at` 未写入数据库，实际插入为存活实例
- 第一次删除创建了存活实例（覆盖虚拟任务），第二次删除才真正逻辑删除该实例

**修改文件**：
- `task/infrastructure/persistence/mapper/TaskMapper.java` - `insert` SQL 新增 `deleted_at` / `#{deletedAt}` 字段

---

### 2026-02-09 - 修复 DELETE 请求体不可靠导致 deleteScope 丢失

**变更内容**：
- 修复 DELETE 请求由于 HTTP 规范限制，request body 可能被客户端/代理丢弃，导致 deleteScope 始终为默认值 THIS_ONLY
- 删除接口同时支持 query parameters 和 request body 两种传参方式，query param 优先
- 请求示例：`DELETE /api/v1/tasks/{taskId}?targetDate=2026-02-15&deleteScope=THIS_AND_FUTURE`

**修改文件**：
- `task/interfaces/controller/TaskController.java` - deleteTask 方法新增 @RequestParam 参数，合并 query param 和 body

---

### 2026-02-09 - 修复删除虚拟任务后查询仍显示的 Bug

**变更内容**：
- 修复 `findInstancedParentIds` SQL 过滤了 `deleted_at IS NULL`，导致已删除的实例不被排除，虚拟展开仍然生成虚拟任务
- 去掉 `deleted_at IS NULL` 条件，已删除实例同样表示"该日期不应展示虚拟任务"
- 新增 `DISTINCT` 避免重复

**修改文件**：
- `task/infrastructure/persistence/mapper/TaskMapper.java` - `findInstancedParentIds` SQL 不再过滤已删除实例

---

### 2026-02-09 - 实现删除任务功能

**变更内容**：
- 实现删除任务接口 `DELETE /api/v1/tasks/{taskId}`
- 支持非重复任务直接逻辑删除
- 支持重复任务 THIS_ONLY 删除（实例化并标记删除，该日期不再显示）
- 支持重复任务 THIS_AND_FUTURE 删除（截断模板 + 清理后续实例）
- 支持虚拟 ID 解析（自动提取模板ID和目标日期）
- 支持幂等（重复删除返回成功）

**删除逻辑**：
1. 非重复任务 / 实例任务：直接逻辑删除
2. 重复模板 THIS_ONLY：实例化目标日期任务并标记已删除，虚拟展开时不再显示
3. 重复模板 THIS_AND_FUTURE：
   - targetDate == 模板起始日期 → 删除整个模板 + 所有实例
   - targetDate > 模板起始日期 → 模板 repeatEndDate 截断到 targetDate-1 + 清理后续实例

**新增文件**：
- `task/application/command/DeleteTaskCommand.java` - 删除任务命令
- `task/application/dto/DeleteTaskResult.java` - 删除任务结果 DTO
- `task/interfaces/dto/DeleteTaskRequest.java` - 删除任务请求 DTO
- `task/interfaces/dto/DeleteTaskResponse.java` - 删除任务响应 DTO

**修改文件**：
- `task/domain/entity/Task.java` - 新增 `softDelete()` 方法
- `task/domain/repository/TaskRepository.java` - 新增 `softDeleteByTaskId`、`findInstanceByParentIdAndDateIncludeDeleted`
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 `softDeleteByTaskId`、`findInstanceByParentIdAndDateIncludeDeleted` SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现新增仓储方法
- `task/application/service/TaskApplicationService.java` - 新增 `deleteTask` 方法及删除分派逻辑
- `task/interfaces/controller/TaskController.java` - 新增 `DELETE /{taskId}` 端点

---

### 2026-02-09 - 修复更新非重复任务时无法转为重复任务的问题

**变更内容**：
- 修复非重复任务更新时忽略 repeatType/repeatConfig 导致无法转为重复任务的问题
- `Task.updateBasicInfo` 新增 repeatType、repeatConfig 参数，支持非重复→重复的类型转换
- `TaskApplicationService.updateNonRepeatTask` 传递并处理重复类型变更，包含重复配置校验

**修改文件**：
- `task/domain/entity/Task.java` - `updateBasicInfo` 方法扩展支持 repeatType 和 repeatConfig
- `task/application/service/TaskApplicationService.java` - `updateNonRepeatTask` 和 `updateTask` 方法适配重复类型变更

---

### 2026-02-09 - 实现更新任务功能

**变更内容**：
- 实现更新任务接口 `PUT /api/v1/tasks/{taskId}`
- 支持非重复任务直接更新（title、priority、date）
- 支持重复任务 THIS_ONLY 更新（按需实例化后更新实例）
- 支持重复任务 THIS_AND_FUTURE 更新（模板分裂策略）
- 支持虚拟 ID 解析（自动提取模板ID和目标日期）
- 支持 targetDate 边界校验（不能早于模板起始日期、不能晚于重复结束日期）

**更新逻辑**：
1. 非重复任务：直接更新实体的 title、priority、date
2. 重复任务 THIS_ONLY：实例化目标日期的虚拟任务，更新该实例的 title、priority
3. 重复任务 THIS_AND_FUTURE：
   - targetDate == 模板起始日期 → 直接更新模板
   - targetDate > 模板起始日期 → 旧模板截止到 targetDate-1，创建新模板，清理旧实例

**新增文件**：
- `task/application/command/UpdateTaskCommand.java` - 更新任务命令
- `task/application/dto/UpdateTaskResult.java` - 更新任务结果 DTO
- `task/interfaces/dto/UpdateTaskRequest.java` - 更新任务请求 DTO
- `task/interfaces/dto/UpdateTaskResponse.java` - 更新任务响应 DTO

**修改文件**：
- `task/domain/entity/Task.java` - 新增更新方法和工厂方法（updateBasicInfo、updateInstanceInfo、updateTemplateInfo、createInstance、createSplitTemplate）
- `task/domain/repository/TaskRepository.java` - 新增 update、findByTaskId、findInstanceByParentIdAndDate、softDeleteInstancesByTemplateIdFromDate
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 update、findByTaskId、findInstanceByParentIdAndDate、softDeleteInstancesByTemplateIdFromDate SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现新增仓储方法
- `task/application/service/TaskApplicationService.java` - 新增 updateTask 方法及虚拟ID解析逻辑
- `task/interfaces/controller/TaskController.java` - 新增 PUT /{taskId} 端点
- `common/response/ErrorCode.java` - 新增 TASK_TARGET_DATE_OUT_OF_RANGE(3012) 错误码

---

### 2026-02-09 - 修复重复任务查询重复返回 Bug

**变更内容**：
- 修复 `findByUserIdAndDate` SQL 查询未排除重复模板任务，导致创建 DAILY 任务后查询同日期返回两条相同任务的问题
- 添加过滤条件 `AND (repeat_type = 'NONE' OR is_repeat_instance = 1)`，确保模板任务仅通过虚拟展开路径返回

**修改文件**：
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 修复 `findByUserIdAndDate` SQL 条件

---

### 2026-02-09 - 实现查询任务列表功能

**变更内容**：
- 实现查询任务列表接口 `GET /api/v1/tasks`
- 支持按日期查询任务，自动虚拟展开重复任务
- 支持 showCompleted 参数过滤已完成任务
- 按优先级分组（P0/P1/P2/P3）返回任务列表
- 返回各象限是否有未完成任务标记（hasUncheckedTasks）

**查询逻辑**：
1. 查询指定日期的实例任务（普通任务 + 已实例化的重复任务）
2. 查询重复模板任务并进行虚拟展开
3. 排除已实例化的模板日期（避免重复）
4. 合并结果，按创建时间排序

**新增文件**：
- `task/domain/service/RepeatTaskMatcher.java` - 重复任务匹配器（DAILY/WEEKLY/MONTHLY）
- `task/application/dto/TaskListResult.java` - 任务列表结果 DTO
- `task/application/dto/TaskDTO.java` - 任务 DTO
- `task/application/dto/SubTaskDTO.java` - 子任务 DTO
- `task/interfaces/dto/TaskListResponse.java` - 任务列表响应 DTO
- `task/interfaces/dto/TaskResponse.java` - 任务响应 DTO
- `task/interfaces/dto/SubTaskResponse.java` - 子任务响应 DTO

**修改文件**：
- `task/domain/repository/TaskRepository.java` - 新增查询方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 新增查询 SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现新方法
- `task/application/service/TaskApplicationService.java` - 新增 queryTasksByDate 方法
- `task/interfaces/controller/TaskController.java` - 新增 GET 接口

---

### 2026-02-09 - 重新实现创建任务功能

**变更内容**：
- 重新实现创建任务接口 `POST /api/v1/tasks`
- 采用 DDD 四层架构：Interfaces / Application / Domain / Infrastructure
- 支持普通任务和重复任务（NONE/DAILY/WEEKLY/MONTHLY）
- 支持重复配置：WEEKLY 需要 weekdays，MONTHLY 需要 daysOfMonth
- 支持重复结束日期（可选）
- 包含业务校验：标题长度、日期范围、单日任务数上限、重复配置格式

**新增文件**：
- `task/domain/valueobject/TaskPriority.java` - 任务优先级枚举
- `task/domain/valueobject/TaskStatus.java` - 任务状态枚举
- `task/domain/valueobject/RepeatType.java` - 重复类型枚举
- `task/domain/entity/Task.java` - 任务聚合根
- `task/domain/repository/TaskRepository.java` - 任务仓储接口
- `task/infrastructure/persistence/po/TaskPO.java` - 任务持久化对象
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 任务 Mapper
- `task/infrastructure/persistence/converter/TaskConverter.java` - 任务转换器
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 任务仓储实现
- `task/application/command/CreateTaskCommand.java` - 创建任务命令
- `task/application/dto/CreateTaskResult.java` - 创建任务结果 DTO
- `task/application/service/TaskApplicationService.java` - 任务应用服务
- `task/interfaces/dto/CreateTaskRequest.java` - 创建任务请求 DTO
- `task/interfaces/dto/CreateTaskResponse.java` - 创建任务响应 DTO
- `task/interfaces/controller/TaskController.java` - 任务控制器

**修改文件**：
- `common/exception/BusinessException.java` - 新增支持 ErrorCode + 自定义消息的构造函数

---

### 2026-02-03 - 任务管理重构 v2.0

**变更内容**：

**一、数据库变更**：
- `sub_task` 表结构重构：
  - 移除：`repeat_type`、`repeat_config`（子任务不再有独立的重复配置）
  - 新增：`is_repeat_template`（是否为模板子任务）、`repeat_template_task_id`（关联的重复模板任务ID）
  - 保留：`is_repeat_instance`、`repeat_parent_id`

**二、API 接口变更**：
- 创建子任务：移除 `repeatType`/`repeatConfig` 参数
- 更新子任务：仅允许修改 `title`
- 删除子任务：改为 `targetDate` + `deleteScope` 参数
- 完成子任务：添加父任务联动自动完成逻辑
- 删除任务：`deleteAll` 改为 `targetDate` + `deleteScope`

**三、子任务完成联动逻辑**：
- 当所有子任务完成时，父任务自动标记为完成
- 当父任务已完成但有子任务被反完成时，父任务恢复为未完成

**四、子任务归属规则**：
- 普通任务 → 普通子任务
- 重复模板 → 模板子任务（`is_repeat_template=1`）
- 重复虚拟任务 → 先实例化父任务，再挂载普通子任务
- 重复实例 → 普通子任务

**涉及文件**：
- `docs/architecture/create.sql` - 子任务表结构重构
- `docs/architecture/API接口契约.md` - 任务管理部分接口更新
- `task/domain/entity/SubTask.java` - 移除重复配置，新增模板子任务支持
- `task/infrastructure/persistence/po/SubTaskPO.java` - 同步字段变更
- `task/infrastructure/persistence/mapper/SubTaskMapper.java` - 更新 SQL 语句
- `task/infrastructure/persistence/converter/SubTaskConverter.java` - 更新转换逻辑
- `task/domain/repository/SubTaskRepository.java` - 新增模板子任务查询方法
- `task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现新方法
- `task/application/service/TaskApplicationService.java` - 重构子任务方法，添加联动逻辑
- `task/interfaces/controller/SubTaskController.java` - 更新接口参数
- `task/interfaces/controller/TaskController.java` - 更新删除任务接口
- `task/interfaces/dto/*SubTask*.java` - 重构子任务相关 DTO
- `task/application/dto/*SubTask*.java` - 重构子任务结果 DTO

---

### 2026-02-09 - 重复任务更新模板分裂策略

**变更内容**：
- 新增 `targetDate` 参数：指定重复任务更新的目标日期
- **THIS_ONLY**：根据 targetDate 将虚拟任务实例化并更新，仅影响该日期
- **THIS_AND_FUTURE 模板分裂策略**：
  - 如果 targetDate 等于模板起始日期：直接更新模板
  - 如果 targetDate 晚于模板起始日期：分裂模板
    - 旧模板设置 `repeatEndDate = targetDate - 1`（历史保留）
    - 创建新模板，`date = targetDate`，应用新设置
    - 清理旧模板在 targetDate 及之后的实例
- 解决了之前 THIS_ONLY 更新仍影响未来日期的问题

**涉及文件**：
- `task/interfaces/dto/UpdateTaskRequest.java` - 新增 targetDate 字段
- `task/interfaces/controller/TaskController.java` - 解析并传递 targetDate 参数
- `task/domain/entity/Task.java` - 新增 createFromTemplate 工厂方法
- `task/application/service/TaskApplicationService.java` - 重构 updateTask、updateRepeatTaskThisOnly、updateRepeatTaskThisAndFuture 方法，新增 locateTemplate、createSplitTemplate 辅助方法
- `docs/architecture/API接口契约.md` - 更新 3.4 更新任务接口说明、参数表、示例

---

### 2026-02-09 - 重构更新任务接口支持更新范围

**变更内容**：
- 新增 `updateScope` 参数：`THIS_ONLY`（仅当天）/ `THIS_AND_FUTURE`（当天及未来）
- 非重复任务：直接更新实体，updateScope 无效
- 重复任务 + THIS_ONLY：实例化后更新实例，仅影响目标日期
- 重复任务 + THIS_AND_FUTURE：更新模板，支持修改 repeatType/repeatConfig
- 支持实体任务和虚拟任务的标题、优先级、日期、循环类型更新

**涉及文件**：
- `task/interfaces/dto/UpdateTaskRequest.java` - 新增 updateScope 字段
- `task/interfaces/controller/TaskController.java` - 传递 updateScope 参数
- `task/application/service/TaskApplicationService.java` - 重构 updateTask 方法，新增 isRepeatTaskId、updateNonRepeatTask、updateRepeatTaskThisOnly、updateRepeatTaskThisAndFuture 方法
- `docs/architecture/API接口契约.md` - 更新 3.4 更新任务接口说明和示例

---

### 2026-02-09 - 月重复支持多个日期

**变更内容**：
- 月重复从单日期 `dayOfMonth: 15` 改为多日期 `daysOfMonth: [1, 15]`
- 支持每月配置多个重复日期（最多31个）
- 自动去重和排序存储
- 匹配逻辑支持任意日期命中即匹配

**涉及文件**：
- `task/application/service/TaskApplicationService.java` - 修改 validateRepeatConfig 的 MONTHLY 校验逻辑
- `task/domain/service/RepeatTaskMatcher.java` - 修改 matchesMonthly 匹配逻辑
- `docs/architecture/API接口契约.md` - 更新 3.2 创建任务接口的 MONTHLY 配置说明和示例

---

### 2026-02-09 - 移除任务接口幂等逻辑

**变更内容**：
- 移除创建任务、更新任务接口的幂等校验逻辑
- 任务名称允许重复，用户可在不同日期创建相同名称的任务
- 移除 `X-Request-Id` 请求头要求（创建任务、更新任务接口）
- 子任务创建仍保留幂等校验逻辑

**涉及文件**：
- `task/application/service/TaskApplicationService.java` - 移除创建任务的幂等校验和缓存逻辑
- `task/interfaces/controller/TaskController.java` - 移除创建任务、更新任务的 X-Request-Id 参数
- `docs/architecture/API接口契约.md` - 更新 3.2 创建任务、3.4 更新任务接口说明

---

### 2026-02-08 - 重复任务子任务按日隔离

**变更内容**：
- 实现重复任务子任务"写时复制"（Copy-on-Write）机制
- 模板子任务作为蓝图，每天继承显示
- 当用户在某天操作子任务时，自动实例化父任务 + 克隆模板子任务到实例
- 操作仅影响当天副本，不影响模板和其他日期
- 查询逻辑优先使用实例自身子任务，无则继承模板

**涉及文件**：
- `task/domain/entity/SubTask.java` - 新增 createInstance 工厂方法
- `task/application/service/TaskApplicationService.java` - 新增 resolveSubTaskForDate、cloneAndFindSubTask 辅助方法；修复 createSubTask、updateSubTask、deleteSubTask、toggleSubTaskComplete、queryTasksByDate
- `task/interfaces/dto/UpdateSubTaskRequest.java` - 新增可选 date 字段
- `task/interfaces/dto/ToggleSubTaskCompleteRequest.java` - 新增可选 date 字段
- `task/interfaces/controller/SubTaskController.java` - 三个端点均支持 date 参数
- `docs/architecture/API接口契约.md` - 更新 3.7-3.10 说明

---

### 2026-02-08 - 实现完成/反完成子任务功能

**变更内容**：
- 实现完成/反完成子任务接口 `POST /api/v1/subtasks/{subTaskId}/toggle-complete`
- 切换子任务完成状态，响应中包含父任务最新状态
- 幂等支持

**涉及文件**：
- `task/domain/entity/SubTask.java` - 新增 complete、uncomplete 方法
- `task/infrastructure/persistence/mapper/SubTaskMapper.java` - 新增 updateStatus SQL
- `task/domain/repository/SubTaskRepository.java` - 新增 updateStatus 方法
- `task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现 updateStatus
- `task/interfaces/dto/ToggleSubTaskCompleteRequest.java` - 请求 DTO（新增）
- `task/interfaces/dto/ToggleSubTaskCompleteResponse.java` - 响应 DTO（新增）
- `task/application/dto/ToggleSubTaskCompleteResult.java` - 结果 DTO（新增）
- `task/application/service/TaskApplicationService.java` - 新增 toggleSubTaskComplete 方法
- `task/interfaces/controller/SubTaskController.java` - 新增 POST /{subTaskId}/toggle-complete 端点

---

### 2026-02-08 - 实现删除子任务功能

**变更内容**：
- 实现删除子任务接口 `DELETE /api/v1/subtasks/{subTaskId}`
- 逻辑删除，幂等支持（不存在视为已删除）

**涉及文件**：
- `task/infrastructure/persistence/mapper/SubTaskMapper.java` - 新增 softDelete SQL
- `task/domain/repository/SubTaskRepository.java` - 新增 softDelete 方法
- `task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现 softDelete
- `task/application/service/TaskApplicationService.java` - 新增 deleteSubTask 方法
- `task/interfaces/controller/SubTaskController.java` - 新增 DELETE /{subTaskId} 端点

---

### 2026-02-08 - 实现更新子任务功能

**变更内容**：
- 实现更新子任务接口 `PUT /api/v1/subtasks/{subTaskId}`
- 支持更新标题和重复设置
- 新增 SubTaskController 处理子任务独立路径的请求

**涉及文件**：
- `task/domain/entity/SubTask.java` - 新增 updateTitle、updateRepeat 方法
- `task/domain/repository/SubTaskRepository.java` - 新增 findBySubTaskId、updateSubTask 方法
- `task/infrastructure/persistence/mapper/SubTaskMapper.java` - 新增 findBySubTaskId、updateSubTask SQL
- `task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现新方法
- `task/interfaces/dto/UpdateSubTaskRequest.java` - 更新子任务请求 DTO（新增）
- `task/interfaces/dto/UpdateSubTaskResponse.java` - 更新子任务响应 DTO（新增）
- `task/application/dto/UpdateSubTaskResult.java` - 更新子任务结果 DTO（新增）
- `task/application/service/TaskApplicationService.java` - 新增 updateSubTask 方法
- `task/interfaces/controller/SubTaskController.java` - 新增控制器（新增）

---

### 2026-02-08 - 实现创建子任务功能

**变更内容**：
- 实现创建子任务接口 `POST /api/v1/tasks/{taskId}/subtasks`
- 支持自定义重复设置或继承父任务重复设置
- 支持虚拟任务 ID（自动提取模板 ID 作为父任务）
- 幂等支持（通过 X-Request-Id）
- 子任务数量上限检查（每个父任务最多 20 条）

**涉及文件**：
- `task/domain/entity/SubTask.java` - 新增带重复设置的 create 工厂方法
- `task/domain/repository/SubTaskRepository.java` - 新增 save、countByParentTaskId 方法
- `task/infrastructure/persistence/mapper/SubTaskMapper.java` - 新增 insert、countByParentTaskId SQL
- `task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现新方法
- `task/interfaces/dto/CreateSubTaskRequest.java` - 创建子任务请求 DTO（新增）
- `task/interfaces/dto/CreateSubTaskResponse.java` - 创建子任务响应 DTO（新增）
- `task/application/dto/CreateSubTaskResult.java` - 创建子任务结果 DTO（新增）
- `task/application/service/TaskApplicationService.java` - 新增 createSubTask 方法
- `task/interfaces/controller/TaskController.java` - 新增 POST /{taskId}/subtasks 端点

---

### 2026-02-08 - 重构更新任务重复设置逻辑

**变更内容**：
- 重构 `updateTask` 方法，支持通过模板 ID、虚拟 ID、实例 ID 修改重复设置
- 支持所有重复变更场景：非重复↔重复、DAILY↔WEEKLY↔MONTHLY
- 新重复规则从生效日期开始，只影响未来日期，已完成的历史实例不受影响
- 生效日期之后的旧实例自动清理，按新规则重新生成虚拟任务
- `TaskMapper.updateTask` SQL 新增 `repeat_end_date` 字段支持

**涉及文件**：
- `task/application/service/TaskApplicationService.java` - 新增 `updateWithRepeatChange` 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - `updateTask` SQL 增加 `repeat_end_date`
- `docs/architecture/API接口契约.md` - 更新 3.4 更新任务说明

---

### 2026-02-08 - 修复重复任务删除逻辑问题

**变更内容**：
- 修复重复模板任务"仅删除当天"时错误删除模板本身的 bug
- 正确逻辑：删除重复模板任务的起始日时，创建"已删除实例"标记而非删除模板
- 确保后续日期的虚拟任务仍可正常显示

**涉及文件**：
- `task/application/service/TaskApplicationService.java` - 修复 deleteRealTask 方法中重复模板任务的删除逻辑

---

### 2026-02-08 - 修复 MONTHLY 重复任务配置问题

**变更内容**：
- 修复 TaskMapper COLUMNS 常量缺少 deleted_at 字段的问题
- 增强 WEEKLY/MONTHLY 类型的校验逻辑，支持字符串形式的数字（如 `"15"` 和 `15` 都有效）
- 标准化存储格式，确保 repeatConfig 中的数值始终为 Integer 类型
- 增强 RepeatTaskMatcher 的解析逻辑，提高容错性
- 添加详细的校验日志，便于问题排查

**涉及文件**：
- `task/infrastructure/persistence/mapper/TaskMapper.java` - COLUMNS 添加 deleted_at 字段
- `task/application/service/TaskApplicationService.java` - 增强 validateRepeatConfig 方法
- `task/domain/service/RepeatTaskMatcher.java` - 增强 matchesWeekly/matchesMonthly 方法

---

### 2026-02-03 - 实现删除任务功能

**变更内容**：
- 实现删除任务接口 `DELETE /api/v1/tasks/{taskId}`
- 支持两种删除方式：
  - `deleteAll = false`：仅删除指定日期的任务
  - `deleteAll = true`：删除目标日期及之后的所有（设置模板 repeatEndDate，不影响之前）
- 支持虚拟任务删除（创建已删除的实例标记）
- 幂等支持（重复删除返回成功）

**涉及文件**：
- `task/interfaces/dto/DeleteTaskRequest.java` - 删除任务请求 DTO（新增）
- `task/interfaces/dto/DeleteTaskResponse.java` - 删除任务响应 DTO（新增）
- `task/application/dto/DeleteTaskResult.java` - 删除任务结果 DTO（新增）
- `task/domain/entity/Task.java` - 添加 deletedAt 字段、delete()/isDeleted()/isRepeatTemplate()/createDeletedInstance()/updateRepeatEndDate() 方法
- `task/infrastructure/persistence/po/TaskPO.java` - 添加 deletedAt 字段
- `task/infrastructure/persistence/converter/TaskConverter.java` - 支持 deletedAt 字段转换
- `task/domain/repository/TaskRepository.java` - 添加 softDelete/softDeleteByParentId/saveDeletedInstance/updateRepeatEndDate/softDeleteInstancesFromDate 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 添加逻辑删除及按日期范围删除 SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现删除相关方法
- `task/application/service/TaskApplicationService.java` - 添加 deleteTask/deleteFromDate 方法
- `task/interfaces/controller/TaskController.java` - 添加 DELETE /api/v1/tasks/{taskId} 端点
- `docs/architecture/API接口契约.md` - 更新删除任务接口说明

---

### 2026-02-03 - 实现更新任务功能

**变更内容**：
- 实现更新任务接口 `PUT /api/v1/tasks/{taskId}`
- 支持更新标题、优先级、日期、重复设置
- 支持虚拟任务 ID（自动实例化后更新）
- 仅更新传入的字段，未传入的保持不变

**涉及文件**：
- `task/interfaces/dto/UpdateTaskRequest.java` - 更新任务请求 DTO（新增）
- `task/interfaces/dto/UpdateTaskResponse.java` - 更新任务响应 DTO（新增）
- `task/application/dto/UpdateTaskResult.java` - 更新任务结果 DTO（新增）
- `task/domain/entity/Task.java` - 添加 updateTitle/updatePriority/updateDate/updateRepeat 方法
- `task/domain/repository/TaskRepository.java` - 添加 updateTask 方法
- `task/infrastructure/persistence/mapper/TaskMapper.java` - 添加 updateTask SQL
- `task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现 updateTask
- `task/application/service/TaskApplicationService.java` - 添加 updateTask 方法
- `task/interfaces/controller/TaskController.java` - 添加 PUT /api/v1/tasks/{taskId} 端点

---

### 2026-02-03 - 实现完成/反完成任务功能

**变更内容**：
- 实现完成/反完成任务接口（支持虚拟任务自动实例化）
- 支持普通任务 ID 和虚拟任务 ID（虚拟任务自动实例化后更新状态）
- 完成任务时检查是否有未完成子任务，有则拒绝完成
- 支持幂等请求

**已实现功能**：
1. `POST /api/v1/tasks/{taskId}/toggle-complete` - 完成/反完成任务
   - 请求头：Authorization: Bearer {access_token}、X-Request-Id
   - 路径参数：taskId（支持虚拟 ID）
   - 请求参数：completed（true=完成，false=反完成）
   - 响应：id、status、completedAt
   - 错误码：3005（父任务存在未完成子任务）

**涉及文件**：
1. `src/main/java/com/gxl/plancore/task/domain/entity/Task.java` - 新增 complete()、uncomplete()、isCompleted() 方法
2. `src/main/java/com/gxl/plancore/task/domain/repository/TaskRepository.java` - 新增 update() 方法
3. `src/main/java/com/gxl/plancore/task/domain/repository/SubTaskRepository.java` - 新增 countIncompleteByParentTaskId() 方法
4. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/TaskMapper.java` - 新增 updateStatus() SQL
5. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/SubTaskMapper.java` - 新增 countIncompleteByParentTaskId() SQL
6. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/TaskRepositoryImpl.java` - 实现 update()
7. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java` - 实现 countIncompleteByParentTaskId()
8. `src/main/java/com/gxl/plancore/task/application/dto/ToggleCompleteResult.java` - 完成/反完成结果 DTO（新增）
9. `src/main/java/com/gxl/plancore/task/application/service/TaskApplicationService.java` - 新增 toggleComplete()、resolveTask()、isVirtualTaskId() 方法
10. `src/main/java/com/gxl/plancore/task/interfaces/dto/ToggleCompleteRequest.java` - 完成/反完成请求 DTO（新增）
11. `src/main/java/com/gxl/plancore/task/interfaces/dto/ToggleCompleteResponse.java` - 完成/反完成响应 DTO（新增）
12. `src/main/java/com/gxl/plancore/task/interfaces/controller/TaskController.java` - 新增 toggleComplete() 端点

---

### 2026-02-03 - 重复任务整体设计与实现

**变更内容**：
- 完成重复任务"虚拟展开 + 按需实例化"方案的完整设计与实现
- 数据库只存 1 条模板记录，查询时动态计算匹配日期生成虚拟任务
- 新增实例化接口 `POST /api/v1/tasks/{taskId}/materialize`
- task 表新增 `repeat_end_date` 字段（支持可选的重复结束日期）
- 重构创建任务响应：移除 `generatedInstancesCount`，新增 `repeatEndDate`
- 新增 `3008: 虚拟任务ID格式错误`、`3009: 任务不存在` 错误码
- API 接口契约 3.1-3.11 重新编号

**设计说明**：
- **模板任务**：`is_repeat_instance = false`，存储重复规则
- **虚拟任务**：查询时动态生成，taskId = `{模板ID}_{日期}`，不持久化
- **实例任务**：用户操作时按需创建，关联 `repeat_parent_id`

**涉及文件**：
1. `docs/architecture/重复任务设计方案.md`（新增，设计文档）
2. `docs/architecture/API接口契约.md`（重写 3.1-3.6，新增 3.3 实例化接口）
3. `docs/architecture/create.sql`（新增 repeat_end_date 字段、索引）
4. `src/main/java/com/gxl/plancore/task/domain/entity/Task.java`（新增 repeatEndDate、createInstance）
5. `src/main/java/com/gxl/plancore/task/domain/service/RepeatTaskMatcher.java`（支持 repeatEndDate）
6. `src/main/java/com/gxl/plancore/task/domain/service/VirtualTaskBuilder.java`
7. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/po/TaskPO.java`（新增 repeatEndDate）
8. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/converter/TaskConverter.java`
9. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/TaskMapper.java`（全面重写）
10. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/TaskRepositoryImpl.java`
11. `src/main/java/com/gxl/plancore/task/application/command/CreateTaskCommand.java`（新增 repeatEndDate）
12. `src/main/java/com/gxl/plancore/task/application/dto/CreateTaskResult.java`（重构）
13. `src/main/java/com/gxl/plancore/task/application/dto/MaterializeResult.java`（新增）
14. `src/main/java/com/gxl/plancore/task/application/service/TaskApplicationService.java`（全面重写）
15. `src/main/java/com/gxl/plancore/task/interfaces/dto/CreateTaskRequest.java`（新增 repeatEndDate）
16. `src/main/java/com/gxl/plancore/task/interfaces/dto/CreateTaskResponse.java`（重构）
17. `src/main/java/com/gxl/plancore/task/interfaces/dto/MaterializeResponse.java`（新增）
18. `src/main/java/com/gxl/plancore/task/interfaces/controller/TaskController.java`（新增 materialize 端点）
19. `src/main/java/com/gxl/plancore/common/response/ErrorCode.java`（新增 3008、3009）

---

### 2026-02-03 - 实现查询任务列表功能

**变更内容**：
- 实现查询指定日期的任务列表接口
- 支持按优先级分组（P0/P1/P2/P3）
- 包含子任务列表
- 支持 showCompleted 参数过滤已完成任务

**已实现功能**：
1. `GET /api/v1/tasks` - 查询任务列表（按日期）

**涉及文件**：
1. `src/main/java/com/gxl/plancore/task/interfaces/controller/TaskController.java`
2. `src/main/java/com/gxl/plancore/task/interfaces/dto/TaskListResponse.java`
3. `src/main/java/com/gxl/plancore/task/interfaces/dto/TaskResponse.java`
4. `src/main/java/com/gxl/plancore/task/interfaces/dto/SubTaskResponse.java`
5. `src/main/java/com/gxl/plancore/task/application/dto/TaskListResult.java`
6. `src/main/java/com/gxl/plancore/task/application/dto/TaskWithSubTasksDTO.java`
7. `src/main/java/com/gxl/plancore/task/application/dto/SubTaskDTO.java`
8. `src/main/java/com/gxl/plancore/task/application/service/TaskApplicationService.java`
9. `src/main/java/com/gxl/plancore/task/domain/entity/SubTask.java`
10. `src/main/java/com/gxl/plancore/task/domain/repository/TaskRepository.java`
11. `src/main/java/com/gxl/plancore/task/domain/repository/SubTaskRepository.java`
12. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/po/SubTaskPO.java`
13. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/TaskMapper.java`
14. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/SubTaskMapper.java`
15. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/converter/SubTaskConverter.java`
16. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/TaskRepositoryImpl.java`
17. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/SubTaskRepositoryImpl.java`

---

### 2026-02-03 - 实现创建任务功能

**变更内容**：
- 实现创建任务接口（支持重复任务与幂等请求）
- 增加任务上下文的领域模型与基础设施实现
- 补充任务模块关键方法注释

**已实现功能**：
1. `POST /api/v1/tasks` - 创建任务

**涉及文件**：
1. `src/main/java/com/gxl/plancore/task/interfaces/controller/TaskController.java`
2. `src/main/java/com/gxl/plancore/task/interfaces/dto/CreateTaskRequest.java`
3. `src/main/java/com/gxl/plancore/task/interfaces/dto/CreateTaskResponse.java`
4. `src/main/java/com/gxl/plancore/task/application/command/CreateTaskCommand.java`
5. `src/main/java/com/gxl/plancore/task/application/dto/CreateTaskResult.java`
6. `src/main/java/com/gxl/plancore/task/application/service/TaskApplicationService.java`
7. `src/main/java/com/gxl/plancore/task/domain/entity/Task.java`
8. `src/main/java/com/gxl/plancore/task/domain/valueobject/TaskPriority.java`
9. `src/main/java/com/gxl/plancore/task/domain/valueobject/TaskStatus.java`
10. `src/main/java/com/gxl/plancore/task/domain/valueobject/RepeatType.java`
11. `src/main/java/com/gxl/plancore/task/domain/repository/TaskRepository.java`
12. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/po/TaskPO.java`
13. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/mapper/TaskMapper.java`
14. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/converter/TaskConverter.java`
15. `src/main/java/com/gxl/plancore/task/infrastructure/persistence/repository/TaskRepositoryImpl.java`

### 2026-02-03 - 实现查询用户信息功能

**变更内容**：
- 实现查询当前用户信息接口
- 返回用户基本信息、打卡统计、昵称修改限制等

**已实现功能**：
1. `GET /api/v1/user/profile` - 查询用户信息接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：userId、nickname、avatar、ipLocation、consecutiveDays、lastCheckInDate、nicknameModifyCount、nicknameNextModifyAt

**涉及文件**：
- `user/interfaces/dto/UserProfileResponse.java` - 查询用户信息响应 DTO（新增）
- `user/application/service/UserApplicationService.java` - 添加 getUserProfile 方法
- `user/interfaces/controller/UserController.java` - 添加 GET /profile 接口

---

### 2026-02-03 - 实现查询总专注时间功能

**变更内容**：
- 实现查询用户累计总专注时间接口
- 直接从 user_focus_stats 汇总表查询，无需聚合计算

**已实现功能**：
1. `GET /api/v1/focus/total-time` - 查询总专注时间接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：totalSeconds（累计秒数）、totalHours（向下取整小时数）
   - 无专注记录时返回 0

**涉及文件**：
- `focus/interfaces/dto/TotalFocusTimeResponse.java` - 总专注时间响应 DTO（新增）
- `focus/application/service/FocusApplicationService.java` - 添加 queryTotalFocusTime 方法
- `focus/interfaces/controller/FocusController.java` - 添加 GET /total-time 接口

---

### 2026-02-03 - 实现结束专注功能

**变更内容**：
- 实现结束专注接口，支持自然结束和手动结束
- 实现计入规则：自然结束计入全部时长，手动结束 >= 50% 才计入
- 新增 user_focus_stats 汇总表支持，结束专注时按需累加
- 支持幂等：已结束的会话重复调用返回相同结果

**已实现功能**：
1. `POST /api/v1/focus/{sessionId}/end` - 结束专注接口
   - 请求头：Authorization: Bearer {access_token}
   - 路径参数：sessionId
   - 请求参数：elapsedSeconds（已完成秒数）、endType（NATURAL/MANUAL）
   - 响应：sessionId、counted、countedSeconds、totalFocusTime
   - 幂等：已结束的会话重复调用返回相同结果

**两张表写入时机**：
- `focus_session`：开始专注时 INSERT，结束专注时 UPDATE（状态、计入信息）
- `user_focus_stats`：结束专注且 counted=true 时累加（首次则 INSERT）

**涉及文件**：
- `focus/interfaces/dto/EndFocusRequest.java` - 结束专注请求 DTO（新增）
- `focus/interfaces/dto/EndFocusResponse.java` - 结束专注响应 DTO（新增）
- `focus/application/command/EndFocusCommand.java` - 结束专注命令（新增）
- `focus/application/dto/EndFocusResult.java` - 结束专注结果 DTO（新增）
- `focus/application/service/FocusApplicationService.java` - 添加 endFocus 方法
- `focus/domain/entity/FocusSession.java` - 添加 end() 领域方法
- `focus/domain/entity/FocusStats.java` - 专注统计实体（新增）
- `focus/domain/repository/FocusStatsRepository.java` - 专注统计仓储接口（新增）
- `focus/infrastructure/persistence/po/FocusStatsPO.java` - 统计PO（新增）
- `focus/infrastructure/persistence/mapper/FocusStatsMapper.java` - 统计Mapper（新增）
- `focus/infrastructure/persistence/converter/FocusStatsConverter.java` - 统计转换器（新增）
- `focus/infrastructure/persistence/repository/FocusStatsRepositoryImpl.java` - 统计仓储实现（新增）
- `focus/interfaces/controller/FocusController.java` - 添加 POST /{sessionId}/end 接口

---

### 2026-02-03 - 实现开始专注功能

**变更内容**：
- 新建专注上下文（Focus Context），完整 DDD 四层架构
- 实现开始专注接口，支持倒计时会话创建
- 校验是否存在进行中的会话（同一用户仅允许一个）
- 专注时长以秒为单位，范围 600 ~ 3600 秒（10 ~ 60 分钟），支持任意秒级精度

**已实现功能**：
1. `POST /api/v1/focus/start` - 开始专注接口
   - 请求头：Authorization: Bearer {access_token}
   - 请求参数：durationSeconds（秒，600~3600）、type（专注类型）
   - 响应：sessionId、durationSeconds、type、startAt、expectedEndAt
   - 错误码：4001（存在进行中的会话）

**涉及文件**：
- `focus/interfaces/controller/FocusController.java` - 专注控制器（新增）
- `focus/interfaces/dto/StartFocusRequest.java` - 开始专注请求 DTO（新增）
- `focus/interfaces/dto/StartFocusResponse.java` - 开始专注响应 DTO（新增）
- `focus/application/command/StartFocusCommand.java` - 开始专注命令（新增）
- `focus/application/dto/StartFocusResult.java` - 开始专注结果 DTO（新增）
- `focus/application/service/FocusApplicationService.java` - 专注应用服务（新增）
- `focus/domain/entity/FocusSession.java` - 专注会话聚合根（新增）
- `focus/domain/valueobject/SessionId.java` - 会话ID值对象（新增）
- `focus/domain/valueobject/FocusDuration.java` - 专注时长值对象（新增）
- `focus/domain/valueobject/FocusType.java` - 专注类型枚举（新增）
- `focus/domain/valueobject/SessionStatus.java` - 会话状态枚举（新增）
- `focus/domain/valueobject/EndType.java` - 结束类型枚举（新增）
- `focus/domain/repository/FocusSessionRepository.java` - 专注会话仓储接口（新增）
- `focus/infrastructure/persistence/po/FocusSessionPO.java` - 专注会话PO（新增）
- `focus/infrastructure/persistence/mapper/FocusSessionMapper.java` - 专注会话Mapper（新增）
- `focus/infrastructure/persistence/converter/FocusSessionConverter.java` - 转换器（新增）
- `focus/infrastructure/persistence/repository/FocusSessionRepositoryImpl.java` - 仓储实现（新增）

---

### 2026-02-03 - 实现更新用户资料功能

**变更内容**：
- 实现更新用户昵称和头像接口
- 昵称修改有频率限制（7天内最多2次）
- 头像为预设头像标识，无修改限制
- 新增 UserController 和 UserApplicationService，与认证逻辑解耦

**已实现功能**：
1. `PUT /api/v1/user/profile` - 更新用户资料接口
   - 请求头：Authorization: Bearer {access_token}
   - 请求参数：nickname（可选）、avatar（可选），至少传一个
   - 响应：nickname、avatar、updatedAt
   - 错误码：5001（昵称包含违规词）、5002（昵称修改过于频繁）

**涉及文件**：
- `user/interfaces/dto/UpdateProfileRequest.java` - 更新资料请求 DTO（新增）
- `user/interfaces/dto/UpdateProfileResponse.java` - 更新资料响应 DTO（新增）
- `user/application/command/UpdateProfileCommand.java` - 更新资料命令（新增）
- `user/application/service/UserApplicationService.java` - 用户应用服务（新增）
- `user/interfaces/controller/UserController.java` - 用户中心控制器（新增）
- `user/domain/entity/User.java` - 添加 changeNickname、changeAvatar 领域方法
- `user/domain/repository/UserRepository.java` - 添加 updateProfile 方法
- `user/infrastructure/persistence/mapper/UserMapper.java` - 添加 updateProfile SQL
- `user/infrastructure/persistence/repository/UserRepositoryImpl.java` - 实现 updateProfile

---

### 2026-02-03 - 实现刷新 Token 功能

**变更内容**：
- 实现使用 refresh_token 刷新 access_token 接口
- 验证 refresh_token 的 JWT 签名和有效性
- 验证数据库中会话状态和 Token 一致性
- 生成新的 access_token 和 refresh_token 并更新数据库

**已实现功能**：
1. `POST /api/v1/auth/refresh` - 刷新 Token 接口
   - 请求参数：refreshToken
   - 响应：accessToken、refreshToken、expiresIn（7200秒）
   - 错误码：401（refresh_token 无效或过期）

**涉及文件**：
- `user/interfaces/dto/RefreshTokenRequest.java` - 刷新Token请求 DTO（新增）
- `user/interfaces/dto/RefreshTokenResponse.java` - 刷新Token响应 DTO（新增）
- `user/application/dto/RefreshResult.java` - 刷新Token结果应用层 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 添加 refreshToken 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /refresh 接口

---

### 2026-02-03 - 实现修改密码功能

**变更内容**：
- 实现修改密码接口
- 验证旧密码正确性
- 验证新密码格式（8-20位）
- 修改成功后自动下线其他设备

**已实现功能**：
1. `POST /api/v1/auth/password` - 修改密码接口
   - 请求头：Authorization: Bearer {access_token}
   - 请求参数：oldPassword、newPassword
   - 响应：message（密码修改成功）
   - 错误码：1001（旧密码错误）、1005（新密码格式不正确）
   - 修改成功后，其他设备会话将被强制下线

**涉及文件**：
- `docs/architecture/API接口契约.md` - 添加 2.9 修改密码接口文档
- `user/interfaces/dto/ChangePasswordRequest.java` - 修改密码请求 DTO（新增）
- `user/interfaces/dto/ChangePasswordResponse.java` - 修改密码响应 DTO（新增）
- `user/application/command/ChangePasswordCommand.java` - 修改密码命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 changePassword 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /password 接口

---

### 2026-02-03 - 实现检查会话状态接口

**变更内容**：
- 新增检查会话状态接口，供前端定时轮询
- 如果会话失效（被踢出/退出/过期），返回 401 UNAUTHORIZED
- 更新 API 接口契约文档

**已实现功能**：
1. `GET /api/v1/auth/session/check` - 检查会话状态接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：valid（是否有效）、userId、deviceId
   - 会话无效时返回 401

**涉及文件**：
- `docs/architecture/API接口契约.md` - 添加 2.8 检查会话状态接口文档
- `user/interfaces/dto/SessionStatusResponse.java` - 会话状态响应 DTO（新增）
- `user/interfaces/controller/AuthController.java` - 添加 GET /session/check 接口

**前端使用建议**：
- 建议每 30-60 秒轮询一次
- 收到 401 响应时，清除本地 Token 并跳转到登录页

---

### 2026-02-03 - 增加会话有效性验证

**变更内容**：
- 增加数据库会话状态验证，确保被踢出/退出的设备无法继续访问
- 验证 device_session 表中的会话状态是否为 ACTIVE
- 验证 refresh_token 是否已过期

**影响接口**：
1. `GET /api/v1/auth/devices` - 查询设备列表
2. `POST /api/v1/auth/devices/{deviceId}/logout` - 踢出指定设备

**不验证的接口**：
- `POST /api/v1/auth/logout` - 退出登录（幂等，即使已退出也返回成功）

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 validateSession 方法
- `user/interfaces/controller/AuthController.java` - 在需要认证的接口中调用 validateSession

---

### 2026-02-03 - 实现退出登录功能

**变更内容**：
- 实现退出当前设备登录接口
- 吊销当前设备的 Token
- 支持幂等：重复退出返回成功

**已实现功能**：
1. `POST /api/v1/auth/logout` - 退出登录接口
   - 请求头：Authorization: Bearer {access_token}
   - 无请求参数
   - 幂等：重复退出返回成功

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 logout 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /logout 接口

---

### 2026-02-03 - 实现踢出指定设备功能

**变更内容**：
- 实现踢出非当前设备的接口
- 支持幂等：重复踢出返回成功
- 不允许踢出当前设备（返回错误码 2001）

**已实现功能**：
1. `POST /api/v1/auth/devices/{deviceId}/logout` - 踢出指定设备接口
   - 请求头：Authorization: Bearer {access_token}
   - 路径参数：deviceId（目标设备ID）
   - 错误码：2001（不能踢出当前设备）
   - 幂等：设备不存在或已退出时返回成功

**涉及文件**：
- `user/application/service/AuthApplicationService.java` - 添加 logoutDevice 方法
- `user/interfaces/controller/AuthController.java` - 添加 POST /devices/{deviceId}/logout 接口

---

### 2026-02-03 - 实现查询设备列表功能

**变更内容**：
- 实现查询当前用户登录设备列表接口
- 区分当前设备和其他设备
- 从 access_token 中解析用户ID和设备ID

**已实现功能**：
1. `GET /api/v1/auth/devices` - 查询设备列表接口
   - 请求头：Authorization: Bearer {access_token}
   - 响应：currentDevice（当前设备）、otherDevices（其他设备列表）
   - 返回设备ID、设备名称、平台、最近登录IP、最近登录时间

**涉及文件**：
- `user/interfaces/dto/DeviceResponse.java` - 设备信息响应 DTO（新增）
- `user/interfaces/dto/DeviceListResponse.java` - 设备列表响应 DTO（新增）
- `user/application/dto/DeviceDTO.java` - 设备信息应用层 DTO（新增）
- `user/application/dto/DeviceListDTO.java` - 设备列表应用层 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 添加 getDevices 方法
- `user/interfaces/controller/AuthController.java` - 添加 getDevices 接口

---

### 2026-02-03 - 实现双Token认证与设备会话管理

**变更内容**：
- 实现 JWT 双 Token 认证（access_token + refresh_token）
- 实现设备会话管理（device_session 表）
- 支持多设备登录（最多10台设备同时在线）
- 超出设备数限制时自动踢出最早设备

**已实现功能**：
1. `POST /api/v1/auth/login` - 登录接口完善
   - 生成 access_token（2小时有效期）
   - 生成 refresh_token（30天有效期）
   - 写入设备会话记录到 device_session 表
   - 设备数量限制检查与自动踢出

**涉及文件**：
- `pom.xml` - 添加 JJWT 依赖（jjwt-api、jjwt-impl、jjwt-jackson）
- `application.properties` - 添加 JWT 配置和设备会话配置
- `common/service/JwtService.java` - JWT 工具类（新增）
- `user/domain/entity/DeviceSession.java` - 设备会话实体（新增）
- `user/domain/repository/DeviceSessionRepository.java` - 设备会话仓储接口（新增）
- `user/application/dto/LoginResult.java` - 登录结果 DTO（新增）
- `user/application/service/AuthApplicationService.java` - 完善 login 方法
- `user/infrastructure/persistence/po/DeviceSessionPO.java` - 设备会话PO（新增）
- `user/infrastructure/persistence/mapper/DeviceSessionMapper.java` - 设备会话Mapper（新增）
- `user/infrastructure/persistence/converter/DeviceSessionConverter.java` - 转换器（新增）
- `user/infrastructure/persistence/repository/DeviceSessionRepositoryImpl.java` - 仓储实现（新增）
- `user/interfaces/controller/AuthController.java` - 更新登录响应

---

### 2026-02-03 - 实现找回密码功能

**变更内容**：
- 实现找回密码接口（生成新密码并发送邮件）
- 添加 Spring Boot Mail 依赖
- 配置 163 邮箱 SMTP 服务
- 实现频率限制（同一邮箱 1 分钟内只能发送 1 次）
- 支持随机密码生成

**已实现功能**：
1. `POST /api/v1/auth/forgot-password` - 找回密码接口
   - 请求参数：email
   - 响应：message（密码重置邮件已发送）
   - 错误码：1007（邮箱未注册）、429（请求过于频繁）

**涉及文件**：
- `pom.xml` - 添加 spring-boot-starter-mail 依赖
- `application.properties` - 添加邮件配置
- `common/service/EmailService.java` - 邮件发送服务（新增）
- `user/interfaces/dto/ForgotPasswordRequest.java` - 找回密码请求 DTO（新增）
- `user/interfaces/dto/ForgotPasswordResponse.java` - 找回密码响应 DTO（新增）
- `user/application/command/ForgotPasswordCommand.java` - 找回密码命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 forgotPassword 方法
- `user/interfaces/controller/AuthController.java` - 添加 forgot-password 接口
- `user/domain/entity/User.java` - 添加 changePassword 方法
- `user/domain/repository/UserRepository.java` - 添加 updatePassword 方法
- `user/infrastructure/persistence/mapper/UserMapper.java` - 添加 updatePassword SQL
- `user/infrastructure/persistence/repository/UserRepositoryImpl.java` - 实现 updatePassword

---

### 2026-02-03 - 实现用户登录功能

**变更内容**：
- 实现邮箱密码登录接口
- 添加登录请求/响应 DTO
- 添加会员权益响应 DTO
- 支持密码验证和用户查询

**已实现功能**：
1. `POST /api/v1/auth/login` - 用户登录接口
   - 请求参数：email、password、deviceInfo
   - 响应：userId、accessToken、refreshToken、userInfo、entitlement
   - 错误码：1001（邮箱或密码错误）

**涉及文件**：
- `user/interfaces/dto/LoginRequest.java` - 登录请求 DTO（新增）
- `user/interfaces/dto/EntitlementResponse.java` - 会员权益响应（新增）
- `user/application/command/LoginCommand.java` - 登录命令（新增）
- `user/application/service/AuthApplicationService.java` - 添加 login 方法
- `user/application/dto/UserDTO.java` - 添加 createdAt 字段
- `user/interfaces/controller/AuthController.java` - 添加登录接口
- `user/interfaces/dto/AuthResponse.java` - 添加 entitlement 字段

**待完成**：
- 会员权益状态查询（从数据库获取实际状态）

---

### 2026-02-02 - 实现用户注册功能

**变更内容**：
- 完成用户注册功能后端实现（Controller → Service → Repository）
- 采用 DDD 四层架构：Interfaces / Application / Domain / Infrastructure
- 实现共享内核：统一响应结构、错误码枚举、全局异常处理
- 实现用户领域模型：User 聚合根、值对象（UserId/Email/Password/Nickname）
- 实现持久化层：UserPO、UserMapper、UserRepositoryImpl
- 更新 create.sql：添加 email、password、nickname_modify_count 等字段

**已实现功能**：
1. `POST /api/v1/auth/register` - 用户注册接口
   - 请求参数：email、password、nickname、deviceInfo
   - 响应：userId、accessToken、refreshToken、userInfo
   - 错误码：1004（邮箱已注册）、1005（密码格式错误）、1006（昵称违规）

**涉及文件**：
- `docs/architecture/create.sql` - 添加 email/password 字段
- `pom.xml` - 添加 spring-security-crypto 依赖
- `common/response/ApiResponse.java` - 统一响应结构
- `common/response/ErrorCode.java` - 错误码枚举
- `common/exception/BusinessException.java` - 业务异常
- `common/exception/GlobalExceptionHandler.java` - 全局异常处理
- `common/config/SecurityConfig.java` - 密码加密器配置
- `user/interfaces/controller/AuthController.java` - 认证控制器
- `user/interfaces/dto/*.java` - 请求/响应 DTO
- `user/application/service/AuthApplicationService.java` - 认证应用服务
- `user/application/command/RegisterCommand.java` - 注册命令
- `user/application/dto/UserDTO.java` - 用户 DTO
- `user/domain/entity/User.java` - 用户聚合根
- `user/domain/valueobject/*.java` - 值对象
- `user/domain/repository/UserRepository.java` - 仓储接口
- `user/infrastructure/persistence/**` - 持久化实现

**待完成**：
- JWT Token 生成与验证
- 设备会话管理
- 会员权益初始化

---

### 2026-02-02 - 移除未打卡注销功能

**变更内容**：
- 移除"连续7天未打卡自动注销账号"功能
- 移除账号注销（Deactivated）状态
- 移除连续未打卡天数统计
- 移除未打卡提醒推送功能

**涉及文件**：
1. `docs/product/PRD_做计划APP_v2.0.md`
   - 删除 `2.9 7天未打卡注销+推送` 章节
   - 更新账号状态定义：移除 Deactivated 状态
   - 简化账号状态机和打卡状态机

2. `docs/architecture/领域模型设计.md`
   - 移除 `User.status`、`User.deactivatedAt`、`User.consecutiveUncheckDays` 属性
   - 移除 `deactivate()`、`incrementUncheckDays()` 等方法
   - 移除 `findUsersToDeactivate()` 仓储方法
   - 简化 `AccountStatus` 枚举（仅保留 ACTIVE）

3. `docs/architecture/API接口契约.md`
   - 移除错误码 `1002`（账号已注销）
   - 简化打卡接口说明

4. `docs/architecture/create.sql`
   - 移除 `user.status`、`user.deactivated_at` 字段
   - 移除注销相关系统配置项
   - 移除注销相关定时任务说明

5. `docs/product/PRD_做计划APP_运营后台_v1.0.md`
   - 移除账号状态筛选（正常/已注销）
   - 移除注销原因、注销时间字段
   - 移除"标记退款"、"批量退款"功能
   - 移除注销用户数、注销率统计
   - 移除未打卡推送配置

---

### 2026-02-02 - 登录/注册统一规范

**变更内容**：
- 移除所有微信授权登录相关功能
- 登录方式改为：**邮箱 + 密码**
- 注册方式改为：**邮箱 + 密码 + 昵称**
- 找回密码改为：**仅输入邮箱**

**涉及文件**：
1. `docs/architecture/领域模型设计.md`
   - 移除 `WechatOpenId` 值对象
   - 新增 `Email` 值对象（用户邮箱，登录唯一标识）
   - 新增 `Password` 值对象（用户密码，加密存储）
   - 更新 `UserRepository` 接口：`findByOpenId` → `findByEmail`

2. `docs/architecture/API接口契约.md`
   - 移除 `2.1 微信授权登录` 接口
   - 新增 `2.1 邮箱密码登录` 接口
   - 新增 `2.2 用户注册` 接口
   - 新增 `2.3 找回密码` 接口
   - 更新错误码：新增 1004-1007

3. `docs/product/PRD_做计划APP_v2.0.md`
   - 免费期起算时间改为"首次注册"
   - 登录状态机改为"邮箱密码登录"

---

### 2026-02-02 - Spring Boot 工程初始化

**变更内容**：
- 项目转换为 Spring Boot 4.0 工程
- 配置 Maven 依赖：MyBatis、Druid、Fastjson2、MySQL 驱动
- 添加 `application.properties` 配置文件
- 添加 `logback.xml` 日志配置

**涉及文件**：
1. `pom.xml` - Maven 依赖配置
2. `src/main/java/com/gxl/plancore/PlanCoreApplication.java` - 启动类
3. `src/main/resources/application.properties` - 应用配置
4. `src/main/resources/logback.xml` - 日志配置

---

## 技术栈

| 组件 | 版本 | 说明 |
|------|------|------|
| JDK | 21 | Java 运行时 |
| Spring Boot | 4.0.0 | Web 框架 |
| MyBatis | 4.0.1 | ORM 框架 |
| Druid | 1.2.27 | 数据库连接池 |
| MySQL | 9.2.0 | 数据库 |
| Fastjson2 | 2.0.43 | JSON 处理 |
| JJWT | 0.12.6 | JWT 生成与验证 |
| Logback | (Spring Boot 内置) | 日志框架 |

---

## 数据库配置

| 配置项 | 值 |
|--------|-----|
| Host | 127.0.0.1:3306 |
| Database | PlanCore |
| Username | root |
| Password | 123456 |

---

## 启动方式

```bash
# 编译
mvn clean compile

# 运行
mvn spring-boot:run

# 打包
mvn clean package
```
